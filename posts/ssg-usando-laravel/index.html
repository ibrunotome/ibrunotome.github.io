<!doctype html><html lang=pt dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SSG usando Laravel | Bruno Tomé</title><meta name=keywords content="laravel"><meta name=description content="O que é SSG (Static Site Generation) É o processo de gerar páginas estáticas (.html) de sua aplicação.
Muitos frameworks oferecem essa ferramenta (Hugo, Next.Js, Nuxt.Js e muitos outros). Aqui vou mostrar que também podemos fazer SSG de sua aplicação Laravel que já está online, usando o próprio Laravel.
Qual a utilidade disso? Provavelmente sua aplicação está nesse momento processando o mesmo conteúdo para cada usuário que acessa sua homepage ou várias outras páginas do seu site, fazendo todo o processo de consumir dados no banco de dados ou cache, processá-los, gerar as views e renderizar um template para devolver ao usuário, de novo e de novo&mldr;"><meta name=author content="Bruno Tomé"><link rel=canonical href=https://ibrunotome.github.io/posts/ssg-usando-laravel/><meta name=google-site-verification content="UA-40327355-1"><link href=/assets/css/stylesheet.min.1eef9c740af75b4e5f773d9d5f757e03e3df71f3a308e73070cc73d55a59a7d7.css integrity="sha256-Hu+cdAr3W05fdz2dX3V+A+PfcfOjCOcwcMxz1VpZp9c=" rel="preload stylesheet" as=style><link rel=icon href=https://ibrunotome.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ibrunotome.github.io/favicon-16x16.ico><link rel=icon type=image/png sizes=32x32 href=https://ibrunotome.github.io/favicon-32x32.ico><link rel=apple-touch-icon href=https://ibrunotome.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ibrunotome.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.81.0"><link rel=alternate hreflang=pt href=https://ibrunotome.github.io/posts/ssg-usando-laravel/><meta property="og:title" content="SSG usando Laravel"><meta property="og:description" content="O que é SSG (Static Site Generation) É o processo de gerar páginas estáticas (.html) de sua aplicação.
Muitos frameworks oferecem essa ferramenta (Hugo, Next.Js, Nuxt.Js e muitos outros). Aqui vou mostrar que também podemos fazer SSG de sua aplicação Laravel que já está online, usando o próprio Laravel.
Qual a utilidade disso? Provavelmente sua aplicação está nesse momento processando o mesmo conteúdo para cada usuário que acessa sua homepage ou várias outras páginas do seu site, fazendo todo o processo de consumir dados no banco de dados ou cache, processá-los, gerar as views e renderizar um template para devolver ao usuário, de novo e de novo&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://ibrunotome.github.io/posts/ssg-usando-laravel/"><meta property="article:published_time" content="2021-03-07T09:33:16-03:00"><meta property="article:modified_time" content="2021-03-07T09:33:16-03:00"><meta property="og:site_name" content="Bruno Tomé"><meta name=twitter:card content="summary"><meta name=twitter:title content="SSG usando Laravel"><meta name=twitter:description content="O que é SSG (Static Site Generation) É o processo de gerar páginas estáticas (.html) de sua aplicação.
Muitos frameworks oferecem essa ferramenta (Hugo, Next.Js, Nuxt.Js e muitos outros). Aqui vou mostrar que também podemos fazer SSG de sua aplicação Laravel que já está online, usando o próprio Laravel.
Qual a utilidade disso? Provavelmente sua aplicação está nesse momento processando o mesmo conteúdo para cada usuário que acessa sua homepage ou várias outras páginas do seu site, fazendo todo o processo de consumir dados no banco de dados ou cache, processá-los, gerar as views e renderizar um template para devolver ao usuário, de novo e de novo&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://ibrunotome.github.io/posts/"},{"@type":"ListItem","position":3,"name":"SSG usando Laravel","item":"https://ibrunotome.github.io/posts/ssg-usando-laravel/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SSG usando Laravel","name":"SSG usando Laravel","description":"O que é SSG (Static Site Generation) É o processo de gerar páginas estáticas (.html) de sua aplicação.\nMuitos frameworks oferecem essa ferramenta (Hugo, Next.Js, Nuxt.Js e muitos …","keywords":["laravel"],"articleBody":"O que é SSG (Static Site Generation) É o processo de gerar páginas estáticas (.html) de sua aplicação.\nMuitos frameworks oferecem essa ferramenta (Hugo, Next.Js, Nuxt.Js e muitos outros). Aqui vou mostrar que também podemos fazer SSG de sua aplicação Laravel que já está online, usando o próprio Laravel.\nQual a utilidade disso? Provavelmente sua aplicação está nesse momento processando o mesmo conteúdo para cada usuário que acessa sua homepage ou várias outras páginas do seu site, fazendo todo o processo de consumir dados no banco de dados ou cache, processá-los, gerar as views e renderizar um template para devolver ao usuário, de novo e de novo…\nApós gerarmos páginas estáticas, esse processo acima não precisará mais acontecer a cada requisição em sua aplicação, pois após termos gerado um .html para cada página, nosso servidor nginx (ou qualquer outro) irá apenas retornar esse .html protinho para o usuário, sem a necessidade de nem enconstar na aplicação.\nComo fazer SSG usando Laravel? Mostrarei abaixo duas maneiras, as duas podem ser usadas ao mesmo tempo (eu uso, inclusive), pois cada uma atende uma necessidade diferente. Para ambas as maneiras, utilizo uma configuração de disco em config/filesystems.php para definir para onde vão os .html gerados:\n1 2 3 4 5 6  'html' = [ 'driver' = 'local', 'root' = public_path('cache-html'), 'url' = env('APP_URL'), 'visibility' = 'public', ],   1. Geração automática em background job Dessa maneira, um job irá realizar em background a geração das páginas estáticas que você predefinir.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80  php namespace App\\Jobs; use Illuminate\\Bus\\Queueable; use Illuminate\\Contracts\\Queue\\ShouldQueue; use Illuminate\\Foundation\\Bus\\Dispatchable; use Illuminate\\Queue\\InteractsWithQueue; use Illuminate\\Queue\\SerializesModels; use Illuminate\\Support\\Facades\\Cache; use Illuminate\\Support\\Facades\\Http; use Illuminate\\Support\\Facades\\Storage; class GenerateStaticSiteJob implements ShouldQueue { use Dispatchable, InteractsWithQueue, Queueable, SerializesModels; public $timeout = 3600; public $tries = 1; private string $baseUrl = ''; public function handle() { Cache::lock('ssg')-get(function () { $this-generateInitialPages(); $urls = array_merge( $this-portugueseUrls(), $this-englishUrls(), ); foreach ($urls as $url) { Storage::disk('html')-delete(\"{$url}.html\"); $content = Http::get(\"{$this-baseUrl}/{$url}\")-body(); Storage::disk('html')-put(\"{$url}.html\", $content); } }); } private function generateInitialPage(): void { Storage::disk('html')-delete('index.html'); $content = Http::get(\"{$this-baseUrl}\")-body(); Storage::disk('html')-put('index.html', $content); Storage::disk('html')-delete('en/index.html'); $content = Http::get(\"{$this-baseUrl}/en?v={$version}\")-body(); Storage::disk('html')-put('en/index.html', $content); Storage::disk('html')-delete('blog/index.html'); $content = Http::get(\"{$this-baseUrl}/blog\")-body(); Storage::disk('html')-put('blog/index.html', $content); } private function portugueseUrls(): array { return [ 'servicos', 'avaliacoes-de-clientes', 'termos-de-servico', 'sobre-nos', 'politica-de-privacidade', 'politica-de-cancelamento', ]; } private function englishUrls(): array { return [ 'en/services', 'en/customer-reviews', 'en/terms-of-service', 'en/about-us', 'en/privacy-policy', 'en/cancel-policy', ]; } }   E pronto, você pode criar um comando para disparar esse job a cada novo deploy da sua aplicação e também criar events/observers/listeners para gerar novamente os .html a cada alteração de conteúdo.\n2. Geração após o término de uma requisição Dessa maneira, ao término de uma requisição que contenha nosso midleware, o conteúdo devolvido ao usuário será escrito em um .html em nosso disco.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  php namespace App\\Http\\Middleware; use Closure; use Illuminate\\Http\\Request; use Illuminate\\Http\\Response; use Illuminate\\Support\\Facades\\Storage; class CacheHtmlResponse { public function handle($request, Closure $next) { return $next($request); } public function terminate(Request $request, $response) { if (!app()-environment('production')) { return; } if (!$response instanceof Response) { return; } if (!is_null($request-getQueryString())) { return; } if ($response-getStatusCode() !== Response::HTTP_OK) { return; } $content = $response-getContent(); $pathParts = explode('/', trim($request-getPathInfo(), '/')); $filePart = array_pop($pathParts); $file = (strlen($filePart) ? $filePart : \"index\") . '.html'; $relativePath = implode(\"/\", $pathParts); Storage::disk('html')-put( $relativePath . \"/\" . $file, $content, ['CacheControl' = 'public,max-age=60,no-transform'] ); } }   Por que também utilizar essa maneira, e não só definir todas as urls no background job mostrado anteriormente?\nImagine um blog com centenas ou milhares de posts, o job levaria vários minutos para terminar, e provavelmente, nem todos os blog posts recebem muitas requisições.\nEsse é o cenário perfeito para usar esse middleware. Após o primeiro leitor receber a renderização do blog post, o .html daquela postagem será gerado e o próximo leitor não precisará esperar pelo processo de renderização novamente.\nConfigurando Nginx para responder os .html gerados Com a configuração abaixo, o nginx irá sempre procurar um .html para as urls que tem os prefixos definidos. Caso não encontre, irá seguir o fluxo normal e mandar a requisição para sua aplicação.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  location ~ ^/(servicos|blog|avaliacoes-de-clientes|termos-de-servico|sobre-nos|politica-de-privacidade|politica-de-cancelamento).*$ { try_files /cache-html/$uri.html$arg_page $uri $uri/ /index.php?$args; } location ~ ^/en\\/?(services|customer-reviews|terms-of-service|about-us|privacy-policy|cancel-policy).*$ { try_files /cache-html/$uri.html$arg_page $uri $uri/ /index.php?$args; } location / { try_files $uri $uri/ /index.php?$query_string; } location ~ \\.php$ { try_files $uri =404; fastcgi_split_path_info ^(.+\\.php)(/.+)$; fastcgi_pass app:9000; fastcgi_index index.php; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $fastcgi_path_info; fastcgi_read_timeout 180; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; }   Conclusão Após os passos acima a aplicação finalmente fica responsável pelo que mais importa, como o checkout e dashboard do usuário. O nginx pode ficar com o processo mais leve e repetitivo de devolver páginas estáticas para o usuário.\n","wordCount":"899","inLanguage":"pt","datePublished":"2021-03-07T09:33:16-03:00","dateModified":"2021-03-07T09:33:16-03:00","author":{"@type":"Person","name":"Bruno Tomé"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ibrunotome.github.io/posts/ssg-usando-laravel/"},"publisher":{"@type":"Organization","name":"Bruno Tomé","logo":{"@type":"ImageObject","url":"https://ibrunotome.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ibrunotome.github.io accesskey=h title="Bruno Tomé (Alt + H)">Bruno Tomé</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ibrunotome.github.io/en/ title=English aria-label=English>English</a></li></ul></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://ibrunotome.github.io/categories/ title=categorias><span>categorias</span></a></li><li><a href=https://ibrunotome.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://ibrunotome.github.io/sobre/ title=sobre><span>sobre</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>SSG usando Laravel</h1><div class=post-meta>March 7, 2021&nbsp;·&nbsp;Bruno Tomé</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#o-que-%c3%a9-ssg-static-site-generation aria-label="O que é SSG (Static Site Generation)">O que é SSG (Static Site Generation)</a></li><li><a href=#qual-a-utilidade-disso aria-label="Qual a utilidade disso?">Qual a utilidade disso?</a></li><li><a href=#como-fazer-ssg-usando-laravel aria-label="Como fazer SSG usando Laravel?">Como fazer SSG usando Laravel?</a><ul><li><a href=#1-gera%c3%a7%c3%a3o-autom%c3%a1tica-em-background-job aria-label="1. Geração automática em background job">1. Geração automática em background job</a></li><li><a href=#2-gera%c3%a7%c3%a3o-ap%c3%b3s-o-t%c3%a9rmino-de-uma-requisi%c3%a7%c3%a3o aria-label="2. Geração após o término de uma requisição">2. Geração após o término de uma requisição</a></li></ul></li><li><a href=#configurando-nginx-para-responder-os-html-gerados aria-label="Configurando Nginx para responder os .html gerados">Configurando Nginx para responder os .html gerados</a></li><li><a href=#conclus%c3%a3o aria-label=Conclusão>Conclusão</a></li></ul></div></details></div><div class=post-content><h2 id=o-que-é-ssg-static-site-generation>O que é SSG (Static Site Generation)<a hidden class=anchor aria-hidden=true href=#o-que-é-ssg-static-site-generation>#</a></h2><p>É o processo de gerar páginas estáticas (.html) de sua aplicação.</p><p>Muitos frameworks oferecem essa ferramenta (Hugo, Next.Js, Nuxt.Js e muitos outros). Aqui vou mostrar que também podemos fazer SSG de sua aplicação Laravel que já está online, usando o próprio Laravel.</p><h2 id=qual-a-utilidade-disso>Qual a utilidade disso?<a hidden class=anchor aria-hidden=true href=#qual-a-utilidade-disso>#</a></h2><p>Provavelmente sua aplicação está nesse momento processando o mesmo conteúdo para cada usuário que acessa sua homepage ou várias outras páginas do seu site, fazendo todo o processo de consumir dados no banco de dados ou cache, processá-los, gerar as views e renderizar um template para devolver ao usuário, de novo e de novo&mldr;</p><p>Após gerarmos páginas estáticas, esse processo acima não precisará mais acontecer a cada requisição em sua aplicação, pois após termos gerado um .html para cada página, nosso servidor nginx (ou qualquer outro) irá apenas retornar esse .html protinho para o usuário, sem a necessidade de nem enconstar na aplicação.</p><h2 id=como-fazer-ssg-usando-laravel>Como fazer SSG usando Laravel?<a hidden class=anchor aria-hidden=true href=#como-fazer-ssg-usando-laravel>#</a></h2><p>Mostrarei abaixo duas maneiras, as duas podem ser usadas ao mesmo tempo (eu uso, inclusive), pois cada uma atende uma necessidade diferente. Para ambas as maneiras, utilizo uma configuração de disco em <code>config/filesystems.php</code> para definir para onde vão os .html gerados:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-php data-lang=php><span class=s1>&#39;html&#39;</span> <span class=o>=&gt;</span> <span class=p>[</span>
    <span class=s1>&#39;driver&#39;</span>     <span class=o>=&gt;</span> <span class=s1>&#39;local&#39;</span><span class=p>,</span>
    <span class=s1>&#39;root&#39;</span>       <span class=o>=&gt;</span> <span class=nx>public_path</span><span class=p>(</span><span class=s1>&#39;cache-html&#39;</span><span class=p>),</span>
    <span class=s1>&#39;url&#39;</span>        <span class=o>=&gt;</span> <span class=nx>env</span><span class=p>(</span><span class=s1>&#39;APP_URL&#39;</span><span class=p>),</span>
    <span class=s1>&#39;visibility&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;public&#39;</span><span class=p>,</span>
<span class=p>],</span>
</code></pre></td></tr></table></div></div><h3 id=1-geração-automática-em-background-job>1. Geração automática em background job<a hidden class=anchor aria-hidden=true href=#1-geração-automática-em-background-job>#</a></h3><p>Dessa maneira, um job irá realizar em background a geração das páginas estáticas que você predefinir.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Jobs</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Illuminate\Bus\Queueable</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Contracts\Queue\ShouldQueue</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Foundation\Bus\Dispatchable</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Queue\InteractsWithQueue</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Queue\SerializesModels</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Facades\Cache</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Facades\Http</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Facades\Storage</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>GenerateStaticSiteJob</span> <span class=k>implements</span> <span class=nx>ShouldQueue</span>
<span class=p>{</span>
    <span class=k>use</span> <span class=nx>Dispatchable</span><span class=p>,</span> <span class=nx>InteractsWithQueue</span><span class=p>,</span> <span class=nx>Queueable</span><span class=p>,</span> <span class=nx>SerializesModels</span><span class=p>;</span>

    <span class=k>public</span> <span class=nv>$timeout</span> <span class=o>=</span> <span class=mi>3600</span><span class=p>;</span>

    <span class=k>public</span> <span class=nv>$tries</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>

    <span class=k>private</span> <span class=nx>string</span> <span class=nv>$baseUrl</span> <span class=o>=</span> <span class=s1>&#39;&lt;seu-dominio-aqui&gt;&#39;</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>()</span>
    <span class=p>{</span>
        <span class=nx>Cache</span><span class=o>::</span><span class=na>lock</span><span class=p>(</span><span class=s1>&#39;ssg&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=k>function</span> <span class=p>()</span> <span class=p>{</span>
            <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>generateInitialPages</span><span class=p>();</span>

            <span class=nv>$urls</span> <span class=o>=</span> <span class=nx>array_merge</span><span class=p>(</span>
                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>portugueseUrls</span><span class=p>(),</span>
                <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>englishUrls</span><span class=p>(),</span>
            <span class=p>);</span>

            <span class=k>foreach</span> <span class=p>(</span><span class=nv>$urls</span> <span class=k>as</span> <span class=nv>$url</span><span class=p>)</span> <span class=p>{</span>
                <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>delete</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$url</span><span class=si>}</span><span class=s2>.html&#34;</span><span class=p>);</span>
                <span class=nv>$content</span> <span class=o>=</span> <span class=nx>Http</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>baseUrl</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=nv>$url</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>body</span><span class=p>();</span>
                <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$url</span><span class=si>}</span><span class=s2>.html&#34;</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>});</span>
    <span class=p>}</span>

    <span class=k>private</span> <span class=k>function</span> <span class=nf>generateInitialPage</span><span class=p>()</span><span class=o>:</span> <span class=nx>void</span>
    <span class=p>{</span>
        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>delete</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>);</span>
        <span class=nv>$content</span> <span class=o>=</span> <span class=nx>Http</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>baseUrl</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>body</span><span class=p>();</span>
        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>(</span><span class=s1>&#39;index.html&#39;</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>

        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>delete</span><span class=p>(</span><span class=s1>&#39;en/index.html&#39;</span><span class=p>);</span>
        <span class=nv>$content</span> <span class=o>=</span> <span class=nx>Http</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>baseUrl</span><span class=si>}</span><span class=s2>/en?v=</span><span class=si>{</span><span class=nv>$version</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>body</span><span class=p>();</span>
        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>(</span><span class=s1>&#39;en/index.html&#39;</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>

        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>delete</span><span class=p>(</span><span class=s1>&#39;blog/index.html&#39;</span><span class=p>);</span>
        <span class=nv>$content</span> <span class=o>=</span> <span class=nx>Http</span><span class=o>::</span><span class=na>get</span><span class=p>(</span><span class=s2>&#34;</span><span class=si>{</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>baseUrl</span><span class=si>}</span><span class=s2>/blog&#34;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>body</span><span class=p>();</span>
        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>(</span><span class=s1>&#39;blog/index.html&#39;</span><span class=p>,</span> <span class=nv>$content</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>private</span> <span class=k>function</span> <span class=nf>portugueseUrls</span><span class=p>()</span><span class=o>:</span> <span class=k>array</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=p>[</span>
            <span class=s1>&#39;servicos&#39;</span><span class=p>,</span>
            <span class=s1>&#39;avaliacoes-de-clientes&#39;</span><span class=p>,</span>
            <span class=s1>&#39;termos-de-servico&#39;</span><span class=p>,</span>
            <span class=s1>&#39;sobre-nos&#39;</span><span class=p>,</span>
            <span class=s1>&#39;politica-de-privacidade&#39;</span><span class=p>,</span>
            <span class=s1>&#39;politica-de-cancelamento&#39;</span><span class=p>,</span>
        <span class=p>];</span>
    <span class=p>}</span>

    <span class=k>private</span> <span class=k>function</span> <span class=nf>englishUrls</span><span class=p>()</span><span class=o>:</span> <span class=k>array</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=p>[</span>
            <span class=s1>&#39;en/services&#39;</span><span class=p>,</span>
            <span class=s1>&#39;en/customer-reviews&#39;</span><span class=p>,</span>
            <span class=s1>&#39;en/terms-of-service&#39;</span><span class=p>,</span>
            <span class=s1>&#39;en/about-us&#39;</span><span class=p>,</span>
            <span class=s1>&#39;en/privacy-policy&#39;</span><span class=p>,</span>
            <span class=s1>&#39;en/cancel-policy&#39;</span><span class=p>,</span>
        <span class=p>];</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>E pronto, você pode criar um comando para disparar esse job a cada novo deploy da sua aplicação e também criar <code>events/observers/listeners</code> para gerar novamente os .html a cada alteração de conteúdo.</p><h3 id=2-geração-após-o-término-de-uma-requisição>2. Geração após o término de uma requisição<a hidden class=anchor aria-hidden=true href=#2-geração-após-o-término-de-uma-requisição>#</a></h3><p>Dessa maneira, ao término de uma requisição que contenha nosso midleware, o conteúdo devolvido ao usuário será escrito em um .html em nosso disco.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-php data-lang=php><span class=o>&lt;?</span><span class=nx>php</span>

<span class=k>namespace</span> <span class=nx>App\Http\Middleware</span><span class=p>;</span>

<span class=k>use</span> <span class=nx>Closure</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Http\Request</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Http\Response</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Illuminate\Support\Facades\Storage</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>CacheHtmlResponse</span>
<span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>handle</span><span class=p>(</span><span class=nv>$request</span><span class=p>,</span> <span class=nx>Closure</span> <span class=nv>$next</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>return</span> <span class=nv>$next</span><span class=p>(</span><span class=nv>$request</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>terminate</span><span class=p>(</span><span class=nx>Request</span> <span class=nv>$request</span><span class=p>,</span> <span class=nv>$response</span><span class=p>)</span>
    <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>app</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>environment</span><span class=p>(</span><span class=s1>&#39;production&#39;</span><span class=p>))</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nv>$response</span> <span class=nx>instanceof</span> <span class=nx>Response</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>is_null</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>getQueryString</span><span class=p>()))</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=nv>$response</span><span class=o>-&gt;</span><span class=na>getStatusCode</span><span class=p>()</span> <span class=o>!==</span> <span class=nx>Response</span><span class=o>::</span><span class=na>HTTP_OK</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=nv>$content</span> <span class=o>=</span> <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>getContent</span><span class=p>();</span>
        <span class=nv>$pathParts</span> <span class=o>=</span> <span class=nx>explode</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span> <span class=nx>trim</span><span class=p>(</span><span class=nv>$request</span><span class=o>-&gt;</span><span class=na>getPathInfo</span><span class=p>(),</span> <span class=s1>&#39;/&#39;</span><span class=p>));</span>
        <span class=nv>$filePart</span> <span class=o>=</span> <span class=nx>array_pop</span><span class=p>(</span><span class=nv>$pathParts</span><span class=p>);</span>
        <span class=nv>$file</span> <span class=o>=</span> <span class=p>(</span><span class=nx>strlen</span><span class=p>(</span><span class=nv>$filePart</span><span class=p>)</span> <span class=o>?</span> <span class=nv>$filePart</span> <span class=o>:</span> <span class=s2>&#34;index&#34;</span><span class=p>)</span> <span class=o>.</span> <span class=s1>&#39;.html&#39;</span><span class=p>;</span>
        <span class=nv>$relativePath</span> <span class=o>=</span> <span class=nx>implode</span><span class=p>(</span><span class=s2>&#34;/&#34;</span><span class=p>,</span> <span class=nv>$pathParts</span><span class=p>);</span>

        <span class=nx>Storage</span><span class=o>::</span><span class=na>disk</span><span class=p>(</span><span class=s1>&#39;html&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>put</span><span class=p>(</span>
            <span class=nv>$relativePath</span> <span class=o>.</span> <span class=s2>&#34;/&#34;</span> <span class=o>.</span> <span class=nv>$file</span><span class=p>,</span>
            <span class=nv>$content</span><span class=p>,</span>
            <span class=p>[</span><span class=s1>&#39;CacheControl&#39;</span> <span class=o>=&gt;</span> <span class=s1>&#39;public,max-age=60,no-transform&#39;</span><span class=p>]</span>
        <span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Por que também utilizar essa maneira, e não só definir todas as urls no background job mostrado anteriormente?</p><p>Imagine um blog com centenas ou milhares de posts, o job levaria vários minutos para terminar, e provavelmente, nem todos os blog posts recebem muitas requisições.</p><p>Esse é o cenário perfeito para usar esse middleware. Após o primeiro leitor receber a renderização do blog post, o .html daquela postagem será gerado e o próximo leitor não precisará esperar pelo processo de renderização novamente.</p><h2 id=configurando-nginx-para-responder-os-html-gerados>Configurando Nginx para responder os .html gerados<a hidden class=anchor aria-hidden=true href=#configurando-nginx-para-responder-os-html-gerados>#</a></h2><p>Com a configuração abaixo, o nginx irá sempre procurar um .html para as urls que tem os prefixos definidos. Caso não encontre, irá seguir o fluxo normal e mandar a requisição para sua aplicação.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-nginx data-lang=nginx><span class=k>location</span> <span class=p>~</span> <span class=sr>^/(servicos|blog|avaliacoes-de-clientes|termos-de-servico|sobre-nos|politica-de-privacidade|politica-de-cancelamento).*$</span> <span class=p>{</span>
  <span class=kn>try_files</span> <span class=s>/cache-html/</span><span class=nv>$uri.html$arg_page</span> <span class=nv>$uri</span> <span class=nv>$uri/</span> <span class=s>/index.php?</span><span class=nv>$args</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>location</span> <span class=p>~</span> <span class=sr>^/en\/?(services|customer-reviews|terms-of-service|about-us|privacy-policy|cancel-policy).*$</span> <span class=p>{</span>
  <span class=kn>try_files</span> <span class=s>/cache-html/</span><span class=nv>$uri.html$arg_page</span> <span class=nv>$uri</span> <span class=nv>$uri/</span> <span class=s>/index.php?</span><span class=nv>$args</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
  <span class=kn>try_files</span> <span class=nv>$uri</span> <span class=nv>$uri/</span> <span class=s>/index.php?</span><span class=nv>$query_string</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>location</span> <span class=p>~</span> <span class=sr>\.php$</span> <span class=p>{</span>
  <span class=kn>try_files</span> <span class=nv>$uri</span> <span class=p>=</span><span class=mi>404</span><span class=p>;</span>
  <span class=kn>fastcgi_split_path_info</span> <span class=s>^(.+\.php)(/.+)</span>$<span class=p>;</span>
  <span class=kn>fastcgi_pass</span> <span class=n>app</span><span class=p>:</span><span class=mi>9000</span><span class=p>;</span>
  <span class=kn>fastcgi_index</span> <span class=s>index.php</span><span class=p>;</span>
  <span class=kn>include</span> <span class=s>fastcgi_params</span><span class=p>;</span>
  <span class=kn>fastcgi_param</span> <span class=s>SCRIPT_FILENAME</span> <span class=nv>$document_root$fastcgi_script_name</span><span class=p>;</span>
  <span class=kn>fastcgi_param</span> <span class=s>PATH_INFO</span> <span class=nv>$fastcgi_path_info</span><span class=p>;</span>
  <span class=kn>fastcgi_read_timeout</span> <span class=mi>180</span><span class=p>;</span>
  <span class=kn>proxy_set_header</span> <span class=s>Host</span>            <span class=nv>$http_host</span><span class=p>;</span>
  <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span>       <span class=nv>$remote_addr</span><span class=p>;</span>
  <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><h2 id=conclusão>Conclusão<a hidden class=anchor aria-hidden=true href=#conclusão>#</a></h2><p>Após os passos acima a aplicação finalmente fica responsável pelo que mais importa, como o checkout e dashboard do usuário. O nginx pode ficar com o processo mais leve e repetitivo de devolver páginas estáticas para o usuário.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ibrunotome.github.io/tags/laravel/>laravel</a></li></ul></footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ibrunotome.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2021 <a href=https://ibrunotome.github.io>Bruno Tomé</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>