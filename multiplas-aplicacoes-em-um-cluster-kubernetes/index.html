<!doctype html><html lang=pt dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Múltiplas aplicações em um cluster Kubernetes | Bruno Tomé</title><meta name=keywords content="gcp,laravel,devops,kubernetes"><meta name=description content="Nesse artigo mostro como preparei múltiplas aplicações para deploy em um único cluster kubernetes e também: o motivo da escolha do kubernetes, os benefícios, as dificuldades enfrentadas e os próximos passos.
O problema inicial Temos pelo menos 5 aplicações principais rodando no Google Cloud Platform (GCP) e também algumas funções que foram desacopladas de uma API e hoje são executadas a partir de google functions, acessadas pelas aplicações principais.
Três dessas aplicações principais rodavam individualmente (uma aplicação por VM) em VMs do tipo n1-standard-1 (1vCPU e 3,75GB de RAM)."><meta name=author content="Bruno Tomé"><link rel=canonical href=https://ibrunotome.github.io/multiplas-aplicacoes-em-um-cluster-kubernetes/><meta name=google-site-verification content="UA-40327355-1"><link href=/assets/css/stylesheet.min.1eef9c740af75b4e5f773d9d5f757e03e3df71f3a308e73070cc73d55a59a7d7.css integrity="sha256-Hu+cdAr3W05fdz2dX3V+A+PfcfOjCOcwcMxz1VpZp9c=" rel="preload stylesheet" as=style><link rel=icon href=https://ibrunotome.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ibrunotome.github.io/favicon-16x16.ico><link rel=icon type=image/png sizes=32x32 href=https://ibrunotome.github.io/favicon-32x32.ico><link rel=apple-touch-icon href=https://ibrunotome.github.io/apple-touch-icon.png><link rel=mask-icon href=https://ibrunotome.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.81.0"><link rel=alternate hreflang=pt href=https://ibrunotome.github.io/multiplas-aplicacoes-em-um-cluster-kubernetes/><link rel=alternate hreflang=en href=https://ibrunotome.github.io/en/multiple-applications-in-one-kubernetes-cluster/><meta property="og:title" content="Múltiplas aplicações em um cluster Kubernetes"><meta property="og:description" content="Nesse artigo mostro como preparei múltiplas aplicações para deploy em um único cluster kubernetes e também: o motivo da escolha do kubernetes, os benefícios, as dificuldades enfrentadas e os próximos passos.
O problema inicial Temos pelo menos 5 aplicações principais rodando no Google Cloud Platform (GCP) e também algumas funções que foram desacopladas de uma API e hoje são executadas a partir de google functions, acessadas pelas aplicações principais.
Três dessas aplicações principais rodavam individualmente (uma aplicação por VM) em VMs do tipo n1-standard-1 (1vCPU e 3,75GB de RAM)."><meta property="og:type" content="article"><meta property="og:url" content="https://ibrunotome.github.io/multiplas-aplicacoes-em-um-cluster-kubernetes/"><meta property="article:published_time" content="2020-03-29T13:29:17-03:00"><meta property="article:modified_time" content="2021-02-28T13:29:00-03:00"><meta property="og:site_name" content="Bruno Tomé"><meta name=twitter:card content="summary"><meta name=twitter:title content="Múltiplas aplicações em um cluster Kubernetes"><meta name=twitter:description content="Nesse artigo mostro como preparei múltiplas aplicações para deploy em um único cluster kubernetes e também: o motivo da escolha do kubernetes, os benefícios, as dificuldades enfrentadas e os próximos passos.
O problema inicial Temos pelo menos 5 aplicações principais rodando no Google Cloud Platform (GCP) e também algumas funções que foram desacopladas de uma API e hoje são executadas a partir de google functions, acessadas pelas aplicações principais.
Três dessas aplicações principais rodavam individualmente (uma aplicação por VM) em VMs do tipo n1-standard-1 (1vCPU e 3,75GB de RAM)."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://ibrunotome.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Múltiplas aplicações em um cluster Kubernetes","item":"https://ibrunotome.github.io/multiplas-aplicacoes-em-um-cluster-kubernetes/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Múltiplas aplicações em um cluster Kubernetes","name":"Múltiplas aplicações em um cluster Kubernetes","description":"Nesse artigo mostro como preparei múltiplas aplicações para deploy em um único cluster kubernetes e também: o motivo da escolha do kubernetes, os benefícios, as dificuldades …","keywords":["gcp","laravel","devops","kubernetes"],"articleBody":"Nesse artigo mostro como preparei múltiplas aplicações para deploy em um único cluster kubernetes e também: o motivo da escolha do kubernetes, os benefícios, as dificuldades enfrentadas e os próximos passos.\nO problema inicial Temos pelo menos 5 aplicações principais rodando no Google Cloud Platform (GCP) e também algumas funções que foram desacopladas de uma API e hoje são executadas a partir de google functions, acessadas pelas aplicações principais.\nTrês dessas aplicações principais rodavam individualmente (uma aplicação por VM) em VMs do tipo n1-standard-1 (1vCPU e 3,75GB de RAM). Todas as aplicações containerizadas e o deploy em produção realizado por um simples:\n1  docker-compose up -d   Mesmo com todo o processo de deploy automatizado, sem gerar dores de cabeça, o desperdício de recursos por parte de duas aplicações e a falta de recursos disponíveis para uma das aplicações me incomodava:\n Uma das aplicações (painel de administração, poucas pessoas com acesso) consumia no máximo 20% da CPU somando todos os containers (nginx, app, schedule, queue, redis, certbot) e no máximo 2 dos 3,75GB de RAM. Uma segunda aplicação com métricas e situação bem parecida à mencionada acima. Uma terceira aplicação, com situação oposta, com métricas recomendando o upgrade da VM para pelo menos 6GB de RAM. Essa aplicação executa jobs em queues, pode ficar alguns minutos sem receber nenhum novo job, porém, quando recebe um novo job ela deve executar todos rapidamente, além de poder receber novos jobs enquanto executa o antigo e já ter que iniciar a execução desse novo job sem espera. No framework utilizado nessa aplicação (Laravel), cada worker utiliza pelo menos 32MB de RAM, se configurarmos um valor máximo de 120 workers, já são necessários pelo menos 3840MB de memória RAM, excedendo os 3,75GB de RAM dessa VM. Além do fato de muitas vezes os 120 workers não serem suficientes para uma entrega rápida, ocasionando em um wait time longo para executar os jobs nas queues:  Essa aplicação definivamente precisava de mais recursos enquanto as outras duas citadas anteriormente não utilizavam todos os recursos disponíveis.\n  Uma quarta aplicação, um MVP (Minimum viable product) rodando em um único container no cloud.run, já estava validada e precisava evoluir com implementação de queues e cache. Como o cloud.run é feito para conteúdo stateless e não possui acesso a redis (pelo menos não de forma fácil, sem ter que expor o redis de alguma VM por exemplo), era necessário tirá-lo dali.\n  Uma quinta aplicação, também em container único, rodava bem no cloud.run e, diferentemente da anterior não precisa de queues. Porém, como possui muitos acessos no cloud.run e o tempo de execução de CPU de cada request dessa aplicação é alto, os custos no cloud.run começaram a incomodar (abaixo os preços do cloud.run com e sem free tier):\n  Uma solução viável para otimização da utilização de recursos seria executar as aplicações em um cluster, possuindo assim o controle de quanto hardware dedicar a cada aplicação e abrindo possibilidade para escalabilidade da terceira aplicação mencionada anteriormente. Para orquestrar os contâiners no cluster, dentre as opções disponíveis eu teria que escolher bem entre duas: Swarm ou Kubernetes, pois possuía um pouco de conhecimento prévio em ambas as ferramentas.\nPor que Kubernetes? Gerenciar um cluster é difícil, aplicar patches de segurança, auto reparo, auto upgrade, auto scaling e garantir disponibilidade são só alguns dos exemplos do que teríamos que manter caso optássemos por gerenciá-lo.\nDentre as opções de cluster citadas anteriormente (Swarm e Kubernetes), nosso cloud provider disponibiliza apenas o serviço de gerenciamento de Kubernetes (na minha opinião, um dos melhores e mais robustos, talvez porque eles projetaram o Kubernetes e a maioria dos seus serviços rodam no mesmo). O serviço é o Google Kubernetes Engine (GKE) e oferece um plano gratuito para um cluster zonal, atendendo nossas necessidades.\nOs custos previstos:\n 2 VMs e2-standard-2 com 2vCPU e 8GB de ram cada, totalizando um cluster com 4vCPU e 16GB de RAM. Com um contrato de desconto por uso contínuo de 3 anos, a previsão mensal de custo é de aproximadamente 45 USD. Loadbalancer http/https, 1 até 5 regras de forwarding custam aproximadamente 18 USD.  Bancos de dados, buckets e outros serviços gerenciados do google não entram na conta pois não foram alterados e seus custos continuaram os mesmos.\nCriando o cluster Kubernetes Podemos criar o cluster no GKE pelo Google Cloud Console ou via linha de comando a partir de nossa máquina:\n Tenha o gcloud e kubectl previamente instalados.\n  Substitua yourclustername, yourprojectname, yourregion (ex para São Paulo: southamerica-east1), yourregion-zone (ex para São Paulo e zona a: southamerica-east1-a) e yournetwork pelos devidos valores.\n 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  gcloud container \\  clusters create \"yourclustername\" \\  --project \"yourprojectname\" \\  --zone \"yourregion-zone\" \\  --no-enable-basic-auth \\  --release-channel \"regular\" \\  --machine-type \"e2-standard-2\" \\  --image-type \"COS\" \\  --disk-type \"pd-ssd\" \\  --disk-size \"20\" \\  --metadata disable-legacy-endpoints=true \\  --scopes \"https://www.googleapis.com/auth/devstorage.read_only\",\"https://www.googleapis.com/auth/logging.write\",\"https://www.googleapis.com/auth/monitoring\",\"https://www.googleapis.com/auth/servicecontrol\",\"https://www.googleapis.com/auth/service.management.readonly\",\"https://www.googleapis.com/auth/trace.append\" \\  --num-nodes \"2\" \\  --enable-stackdriver-kubernetes \\  --enable-ip-alias \\  --network \"projects/yourprojectname/global/networks/yournetwork\" \\  --subnetwork \"projects/yourprojectname/regions/yourregion/subnetworks/yournetwork\" \\  --default-max-pods-per-node \"110\" \\  --enable-autoscaling \\  --min-nodes \"2\" \\  --max-nodes \"3\" \\  --no-enable-master-authorized-networks \\  --addons HorizontalPodAutoscaling,HttpLoadBalancing,NodeLocalDNS,ApplicationManager \\  --enable-autoupgrade \\  --enable-autorepair \\  --max-surge-upgrade 1 \\  --max-unavailable-upgrade 0 \\  --enable-shielded-nodes   Definimos que o cluster terá no mínimo 2 nodes com máquinas do tipo e2-standard-2 (máquinas contratadas no commitment discount mencionado anteriormente), e no máximo 3 nodes.\nAltere o contexto do kubectl para o GKE:\n1  kubectl config set-context gke_yourprojectname_yourregion-zone_yourclustername   Preparando os containers Como dito no primeiro tópico, as aplicações já rodavam containerizadas. Um container dedicado para a aplicação web, um para as queues, um para a execução de schedules, um container redis e um nginx. O container certbot foi descartado pois foi adotada outra abordagem para gerenciamento dos certificados SSL.\nCaso você ainda não tenha containerizado sua aplicação, prepare-a de modo que respeite o Twelve-Factor App.\nPreparando os manifestos Aqui vem o primeiro susto para quem era acostumado a subir o ambiente de produção inteiro com um único arquivo docker-compose.yaml 🙃\nMostrarei o propósito de cada arquivo. Veja detalhes e conceitos do Kubernetes em sua documentação.\nA infraestrutura da aplicação é definida como código, os controllers do Kubernetes checam em loop se o estado atual da aplicação é igual ao estado definido via código, e caso não seja, aplica as modificações necessárias.\nOs manifestos podem ser definidos em YAML ou JSON, as extensões .yaml, .yml e .json são aceitas. Coloco todos no mesmo diretório para facilitar o deploy com o comando:\n1  kubectl apply -f k8s/   01-namespace.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  apiVersion:v1kind:Namespacemetadata:name:yourapp1labels:name:yourapp1---apiVersion:v1kind:ResourceQuotametadata:name:resource-quotanamespace:yourapp1spec:hard:requests.cpu:300mrequests.memory:1536Milimits.cpu:500mlimits.memory:2048Mi  Nesse arquivo defino o Namespace da aplicação. Com namespaces é possível definir o escopo das aplicações. Assim é possível executar várias aplicações diferentes no mesmo cluster sem que interfiram uma na outra (a comunicação entre namespaces ainda é possível através de serviços expostos como mostrarei). Outra utilidade de namespaces é separar ambientes de staging e production por exemplo. Por padrão, caso namespaces não sejam definidos os deploys são realizados no namespace default.\nNo mesmo arquivo defino um deploy do tipo Resource Quota, nele é possível definir os recursos e limites de recursos solicitados pelo namespace. No exemplo, defino que:\n  requests.cpu: 300m - todos os componentes do namespace somados podem requisitar (somados) no máximo 300 millicores de cpu (1vCPU = 1000m, valores de cpu podem ser definidos a partir de 1m).\n  requests.memory: 1536Mi - todos os componentes do namespace somados podem requisitar (somados) no máximo 1536Mi de memória (1 Mebibyte (MiB) = (1024)^2 bytes = 1048576 bytes).\n  limits.cpu: 500m - todos os componentes do namespace somados (apesar de poderem requisitar 300m de cpu definidos anteriormente) podem utilizar o máximo 500 millicores de cpu.\n  limits.memory: 2048Mi - todos os componentes do namespace somados (apesar de poderem requisitar 1536Mi de memória definidos anteriormente) podem utilizar no máximo 2048Mi de memória.\n  Quando os limites de cpu definidos são atingidos, a aplicação começa a sofrer throttled de cpu, ou seja, sua performance é afetada.\nQuando os limites de memória são atingidos, não é possível “comprimir” a memória como é feito com cpu, e seu Pod é terminado.\nQuando um deploy de uma nova versão da sua aplicação é feita, caso o limite de cpu ou memória seja excedido, os pods não serão executados e ficarão com o estado Evicted.\nA definição de ResourceQuota para um namespace é opcional, porém garante que uma aplicação não consuma recursos demasiadamente.\n02-nfs-server-deployment.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43  apiVersion:apps/v1kind:Deploymentmetadata:name:nfs-servernamespace:yourapp1spec:replicas:1selector:matchLabels:name:nfs-servertemplate:metadata:labels:name:nfs-serverspec:containers:- name:nfs-serverimage:gcr.io/google_containers/volume-nfs:latestports:- name:nfscontainerPort:2049- name:mountdcontainerPort:20048- name:rpcbindcontainerPort:111securityContext:privileged:trueresources:requests:cpu:1mmemory:168Milimits:cpu:2mmemory:192MivolumeMounts:- name:datamountPath:/exportsvolumes:- name:datagcePersistentDisk:pdName:yourapp1-nfs-diskfsType:ext4  Nesse arquivo defino o deployment de um volume NFS, já que o padrão GCEPersistentDisk do GKE não suporta o tipo de acesso ReadWriteMany para ser lido e escrito por vários nodes ao mesmo tempo.\nEste volume será usado para persistir os dados do redis e também as páginas estáticas que são geradas a partir do container app e compartilhadas com o container nginx.\nAlguns detalhes do arquivo:\n O namespace deve ser o mesmo definido anteriormente para que o escopo do deploy seja o mesmo namespace. Ele possui apenas uma réplica. As requests e limits de cpu desse deployment podem ser bem pequenas (mostro mais a frente como analisar). O volume é montado no path /exports do disco. O disco definido em pdName nos volumes deve ser criado anteriormente com:  1  gcloud compute disks create --size=1GB --zone=yourregion-zone --type=pd-ssd yourapp1-nfs-disk   03-nfs-server-service.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  apiVersion:v1kind:Servicemetadata:name:nfs-servernamespace:yourapp1spec:ports:- name:nfsport:2049- name:mountdport:20048- name:rpcbindport:111selector:name:nfs-server  O service acima é o responsável por expor o deployment criado anteriormente para ser acessado pelos outros pods. O serviço é exposto com ClusterIp, apenas para outros pods, e não para a internet.\nLembre-se de definir o selector do service com o mesmo valor definido nas labels do selector no deployment.\n04-redis-statefulset.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36  apiVersion:apps/v1kind:StatefulSetmetadata:name:redisnamespace:yourapp1spec:serviceName:redisselector:matchLabels:name:redistemplate:metadata:name:redislabels:name:redisspec:containers:- name:redisimage:redis:5.0.5-alpineports:- containerPort:6379resources:requests:cpu:5mmemory:14Milimits:cpu:5mmemory:16MivolumeMounts:- name:datamountPath:/datavolumes:- name:datanfs:server:nfs-server.yourapp1.svc.cluster.localpath:\"/redis/data\"  O deploy do redis é do tipo StatefulSet, o volume pode acessar diretamente o serviço deployado anteriormente via ..svc.cluster.local.\n05-redis-service.yaml 1 2 3 4 5 6 7 8 9 10 11  apiVersion:v1kind:Servicemetadata:name:redisnamespace:yourapp1spec:ports:- port:6379protocol:TCPselector:name:redis  Expõe o redis com ClusterIp para ser acessado pelos outros pods.\n06-app-deployment.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101  apiVersion:apps/v1kind:Deploymentmetadata:name:appnamespace:yourapp1labels:name:appannotations:secret.reloader.stakater.com/reload:\"env\"spec:replicas:2revisionHistoryLimit:1selector:matchLabels:name:appstrategy:type:RollingUpdaterollingUpdate:maxSurge:1maxUnavailable:50%template:metadata:labels:name:appspec:containers:- name:appimage:gcr.io/yourproject/yourapp1:TAG_NAMEcommand:[\"/bin/bash\"]args:- -c- |sleep 12 php artisan migrate --force php artisan optimize php artisan view:cache ln -s public html ln -s /var/www /usr/share/nginx /usr/local/sbin/php-fpmenvFrom:- secretRef:name:envreadinessProbe:initialDelaySeconds:20periodSeconds:10timeoutSeconds:5failureThreshold:3successThreshold:1tcpSocket:port:9000ports:- containerPort:9000resources:requests:cpu:20mmemory:320Milimits:cpu:50mmemory:512MivolumeMounts:- name:staticmountPath:/static- name:cache-htmlmountPath:/var/www/public/cache-htmllifecycle:postStart:exec:command:[\"/bin/bash\",\"-c\",\"cp -r /var/www/public/. /static\"]- name:cloudsql-proxyimage:gcr.io/cloudsql-docker/gce-proxy:latestcommand:[\"/cloud_sql_proxy\",\"-instances=yourproject:cloudsql-region:yourproject=tcp:5432\",\"-credential_file=/secrets/cloudsql/cloudsqlproxy.json\",]resources:requests:cpu:1mmemory:8Milimits:cpu:10mmemory:16MivolumeMounts:- name:cloudsql-instance-credentialsmountPath:/secrets/cloudsqlreadOnly:truevolumes:- name:staticnfs:server:nfs-server.yourapp1.svc.cluster.localpath:\"/static\"- name:cache-htmlnfs:server:nfs-server.yourapp1.svc.cluster.localpath:\"/cache-html\"- name:cloudsql-instance-credentialssecret:secretName:cloudsql-instance-credentials  Responsável pelo deploy da aplicação laravel com fpm, em annotations temos uma anotação secret.reloader.stakater.com/reload: \"env\" que irá realizar o deploy de um novo pod sempre que a secret com nome env for atualizada. Esse comportamento não é padrão do kubernetes e para habilitá-lo instalamos um controller chamado Reloader com o comando:\n1  kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml    replicas: 2 - definimos que o deploy irá criar 2 pods. revisionHistoryLimit: 1 - só teremos acesso a uma versão anterior a atual para rollback.  Em strategy:\n type: RollingUpdate - Nosso deploy é do tipo Rolling Update. maxSurge: 1 - Só pode surgir um novo pod por vez. maxUnavailable: 50% - No mínimo metade dos pods devem estar disponíveis durante o deploy, ou seja, no exemplo com replicas: 2 e maxSurge: 1, um novo pod surgirá, então um pod antigo será terminado (respeitando o maxUnavailable: 50%), então um novo pod surgirá, e o último pod antigo será terminado.  Em containers:\nEsse pod possui 2 containers, o app principal e um sidecar (um proxy para conexão com o banco de dados no Google Cloud SQL).\nNo primeiro container app temos:\n commands: e args: - são os comandos que serão executados pelo nosso container, o sleep inicial serve para aguardar até que o container sidecar esteja disponível. Na versão 1.18 em diante esse sleep não será mais necessário. envFrom: - injetamos nossas variáveis de ambiente (mostrarei como criá-las no tópico Automatizando o processo de teste e deploy com um pipeline CI/CD). readinessProbe: - O container só receberá tráfego após uma conexão TCP bem sucedida com o container na porta 9000. volumeMounts: - O volume static compartilha assets entre o app e o nginx. O volume cache-html armazena algumas páginas de forma estática geradas a partir do conteúdo dinâmico, evitando a renderização a todo momento.  No sidecar container cloudsql-proxy fazemos a autenticação com o uso de um secret que também mostro como criá-la no tópico Automatizando o processo de teste e deploy com um pipeline CI/CD.\n07-app-hpa.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  apiVersion:autoscaling/v2beta1kind:HorizontalPodAutoscalermetadata:name:appnamespace:yourapp1spec:maxReplicas:3minReplicas:1scaleTargetRef:apiVersion:apps/v1kind:Deploymentname:appmetrics:- type:Resourceresource:name:cputargetAverageUtilization:90- type:Resourceresource:name:memorytargetAverageUtilization:90  O Horizontal Pod Autoscaler (HPA) escala automaticamente o número de pods do nosso deployment. No exemplo em 06-app-deployment.yaml, nosso deployment foi feito com duas réplicas, o HPA acima irá escalar esse deployment para 1 ou 3 réplicas baseado na média de utilização de cpu e memória do deployment.\n08-app-service.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13  apiVersion:v1kind:Servicemetadata:name:appnamespace:yourapp1labels:name:appspec:ports:- protocol:TCPport:9000selector:name:app  Expõe o app com ClusterIp para ser acessado pelos outros pods.\n09-queue-deployment.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69  apiVersion:apps/v1kind:Deploymentmetadata:name:queuenamespace:yourapp1labels:name:queueannotations:secret.reloader.stakater.com/reload:\"env\"spec:replicas:1revisionHistoryLimit:1selector:matchLabels:name:queuestrategy:type:RollingUpdaterollingUpdate:maxSurge:1maxUnavailable:50%template:metadata:labels:name:queuespec:containers:- name:queueimage:gcr.io/yourproject/yourapp1:TAG_NAMEcommand:[\"/bin/bash\"]args:- -c- |php artisan config:cache php artisan horizon --quietenvFrom:- secretRef:name:envresources:requests:cpu:100mmemory:128Milimits:cpu:150mmemory:512Mi- name:cloudsql-proxyimage:gcr.io/cloudsql-docker/gce-proxy:latestcommand:[\"/cloud_sql_proxy\",\"-instances=yourproject:cloudsql-region:yourproject=tcp:5432\",\"-credential_file=/secrets/cloudsql/cloudsqlproxy.json\",]resources:requests:cpu:1mmemory:8Milimits:cpu:10mmemory:16MivolumeMounts:- name:cloudsql-instance-credentialsmountPath:/secrets/cloudsqlreadOnly:truevolumes:- name:cloudsql-instance-credentialssecret:secretName:cloudsql-instance-credentials  Os conceitos são os mesmos do 06-app-deployment.yaml, porém iniciamos com apenas uma réplica e o HPA a seguir controla a necessidade de outras réplicas.\n10-queue-hpa.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  apiVersion:autoscaling/v2beta1kind:HorizontalPodAutoscalermetadata:name:queuenamespace:yourapp1spec:maxReplicas:2minReplicas:1scaleTargetRef:apiVersion:apps/v1kind:Deploymentname:queuemetrics:- type:Resourceresource:name:cputargetAverageUtilization:100- type:Resourceresource:name:memorytargetAverageUtilization:90  Os conceitos são os mesmos do 07-app-hpa.yaml, porém para a queue.\n11-schedule-deployment.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65  apiVersion:apps/v1kind:Deploymentmetadata:name:schedulenamespace:yourapp1labels:name:scheduleannotations:secret.reloader.stakater.com/reload:\"env\"spec:replicas:1revisionHistoryLimit:1selector:matchLabels:name:scheduletemplate:metadata:labels:name:schedulespec:containers:- name:scheduleimage:gcr.io/yourproject/yourapp1:TAG_NAMEcommand:[\"/bin/bash\"]args:- -c- |php artisan config:cache chmod +x schedule.sh /var/www/schedule.shenvFrom:- secretRef:name:envresources:requests:cpu:10mmemory:8Milimits:cpu:30mmemory:64Mi- name:cloudsql-proxyimage:gcr.io/cloudsql-docker/gce-proxy:latestcommand:[\"/cloud_sql_proxy\",\"-instances=yourproject:cloudsql-region:yourproject=tcp:5432\",\"-credential_file=/secrets/cloudsql/cloudsqlproxy.json\",]resources:requests:cpu:1mmemory:8Milimits:cpu:15mmemory:16MivolumeMounts:- name:cloudsql-instance-credentialsmountPath:/secrets/cloudsqlreadOnly:truevolumes:- name:cloudsql-instance-credentialssecret:secretName:cloudsql-instance-credentials  Se você já usa kubernetes provavelmente pensou “existe um controller CronJob para isso”. Sim, porém meus crons são executados a cada minuto, o processo de um controller disparar um job, subir um pod, executar o container, matar o pod, e repetir de novo alguns segundos depois não me parece legal. Não sou o único a adotar essa abordagem para conjobs a cada minuto.\n12-nginx-configmap.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116  apiVersion:v1kind:ConfigMapmetadata:name:nginx-configmapnamespace:yourapp1data:nginx.conf:|user nginx; worker_processes auto; events { worker_connections 4096; multi_accept on; use epoll; } http { include mime.types; server_tokens off; default_type application/octet-stream; client_body_buffer_size 10K; client_header_buffer_size 1k; client_max_body_size 10m; large_client_header_buffers 4 16k; access_log off; error_log /dev/stderr; sendfile on; keepalive_timeout 65; keepalive_requests 100; log_format json_combined escape=json '{' '\"time_local\":\"$time_local\",' '\"remote_addr\":\"$remote_addr\",' '\"remote_user\":\"$remote_user\",' '\"request\":\"$request\",' '\"status\": \"$status\",' '\"body_bytes_sent\":\"$body_bytes_sent\",' '\"request_time\":\"$request_time\",' '\"http_referrer\":\"$http_referer\",' '\"http_user_agent\":\"$http_user_agent\"' '}'; server { listen 80; server_name yourapp1.com www.yourapp1.com; index index.php index.html; root /usr/share/nginx/html; if ($host = \"www.yourapp1.com\") { rewrite ^ https://yourapp1.com$request_uri? permanent; } if ($http_x_forwarded_proto = \"http\") { rewrite ^ https://yourapp1.com$request_uri? permanent; } add_header 'Referrer-Policy' 'same-origin'; add_header 'Feature-Policy' \"geolocation 'none'; vibrate 'none'\"; add_header 'Strict-Transport-Security' 'max-age=31536000; includeSubdomains; preload'; add_header 'X-Content-Type-Options' 'nosniff'; add_header 'X-Frame-Options' 'SAMEORIGIN'; add_header 'X-XSS-Protection' '1; mode=block'; gzip on; gzip_disable \"MSIE [1-6]\\.(?!.*SV1)\"; gzip_vary on; gzip_proxied any; gzip_comp_level 6; gzip_buffers 16 8k; gzip_http_version 1.1; gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript text/x-js; location ~* \\.(js|jpg|jpeg|gif|png|css|tgz|gz|rar|bz2|doc|pdf|ppt|tar|wav|bmp|rtf|swf|ico|flv|txt|woff|woff2|svg|xml)$ { root /static; expires 365d; access_log off; etag on; if_modified_since exact; add_header Pragma \"public\"; add_header Cache-Control \"max-age=31536000, public\"; add_header Access-Control-Allow-Origin *; try_files $uri =404; } location = / { try_files /cache-html/index.html /index.php?$args; } location ~ ^/(comprar|blog|recompensas|avaliacoes-de-clientes|termos-de-servico|sobre-nos|politica-de-privacidade|politica-de-cancelamento).*$ { try_files /cache-html/$uri.html$arg_page $uri $uri/ /index.php?$args; } location / { try_files $uri $uri/ /index.php?$query_string; } location ~ \\.php$ { try_files $uri =404; fastcgi_split_path_info ^(.+\\.php)(/.+)$; fastcgi_pass app:9000; fastcgi_index index.php; include fastcgi_params; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; fastcgi_param PATH_INFO $fastcgi_path_info; fastcgi_read_timeout 180; proxy_set_header Host $http_host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; } } }  O ConfigMap com a configuração nginx utilizada para essa aplicação.\n13-nginx-deployment.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60  apiVersion:apps/v1kind:Deploymentmetadata:name:nginxnamespace:yourapp1annotations:configmap.reloader.stakater.com/reload:\"nginx-configmap\"spec:replicas:1selector:matchLabels:name:nginxtemplate:metadata:labels:name:nginxspec:containers:- name:nginximage:nginx:1.17-alpinecommand:[\"/bin/sh\",\"-c\",\"touch /usr/share/nginx/html/index.php; nginx -g 'daemon off;'\",]resources:requests:cpu:1mmemory:16Milimits:cpu:2mmemory:32Miports:- containerPort:80volumeMounts:- name:nginx-configmapmountPath:/etc/nginx/nginx.confsubPath:nginx.confreadOnly:true- name:staticmountPath:/static- name:cache-htmlmountPath:/usr/share/nginx/html/cache-htmlvolumes:- name:nginx-configmapconfigMap:name:nginx-configmapitems:- key:nginx.confpath:nginx.conf- name:staticnfs:server:nfs-server.yourapp1.svc.cluster.localpath:\"/static\"- name:cache-htmlnfs:server:nfs-server.yourapp1.svc.cluster.localpath:\"/cache-html\"  O deployment do nginx utiliza o nfs-server criado no passo 2 e exposto no passo 3, ele terá acesso aos conteúdos compartilhados pelo passo 6. Além de utilizar o nginx-configmap criado no passo anterior.\n14-nginx-hpa.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  apiVersion:autoscaling/v2beta1kind:HorizontalPodAutoscalermetadata:name:nginxnamespace:yourapp1spec:maxReplicas:2minReplicas:1scaleTargetRef:apiVersion:apps/v1kind:Deploymentname:nginxmetrics:- type:Resourceresource:name:cputargetAverageUtilization:90- type:Resourceresource:name:memorytargetAverageUtilization:90  Os conceitos são os mesmos do 07-app-hpa.yaml, porém para o nginx.\n15-nginx-service.yaml 1 2 3 4 5 6 7 8 9 10 11 12  apiVersion:v1kind:Servicemetadata:name:nginxnamespace:yourapp1spec:type:NodePortports:- port:80targetPort:80selector:name:nginx  Expõe o nginx com o tipo NodePort para que seja acessado pela internet.\n16-managedcerts.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  apiVersion:networking.gke.io/v1beta1kind:ManagedCertificatemetadata:name:yourapp1-comnamespace:yourapp1spec:domains:- yourapp1.com---apiVersion:networking.gke.io/v1beta1kind:ManagedCertificatemetadata:name:www-yourapp-comnamespace:yourapp1spec:domains:- www.yourapp1.com  Os certificados SSL auto gerenciados pelo Google. Mais detalhes no tópico Adicionando certificados SSL auto gerenciados\n17-ingress.yaml 1 2 3 4 5 6 7 8 9 10 11 12  apiVersion:networking.k8s.io/v1beta1kind:Ingressmetadata:name:nginxnamespace:yourapp1annotations:kubernetes.io/ingress.global-static-ip-name:yourapp1-global-ip-namenetworking.gke.io/managed-certificates:yourapp1-com,www-yourapp1-comspec:backend:serviceName:nginxservicePort:80  Criaremos um ip global para ser utilizado pela aplicação:\n1  gcloud compute addresses create yourapp1-global-ip-name --global   O ingress irá expor a aplicação para a internet. Em annotations adicionamos o nome do IP global criado acima e o nome dos certificados gerenciados criados no passo anterior. Em spec definimos que todas as requests serão encaminhadas para o serviço nginx na porta 80, criado em 15-nginx-service.yaml.\nPor trás dos panos, um load balancer é criado com duas forwarding rules (http e https) apontando para esse ingress e sua spec.\nAdicionando certificados SSL auto gerenciados Crie uma zona DNS\nhttps://cloud.google.com/dns/docs/\nAponte o NS em seu register domain para os mostrados na zona DNS criada acima.\nAponte o record A para o IP criado anteriormente em 17-ingress.yaml. Obtenha o IP com o comando:\n1 2 3  gcloud compute addresses \\  describe yourapp1-global-ip-name --global \\  --format='value(address)'   Veja com o comando host yourapp1.com se ele já está apontando para o IP criado anteriormente.\nNo processo de deploy, quando o arquivo 16-managedcerts.yaml for aplicado (kubectl apply -f 16-managedcerts.yaml), o processo de geração do certificado irá levar de 15 a 30 minutos.\nRealizando o deploy dos manifestos O deploy pode ser realizado por arquivo:\n1 2  kubectl apply -f 01-namespace.yaml kubectl apply -f 02-nfs-server-deployment.yaml   Ou todos os arquivos da pasta\n1  kubectl apply -f k8s/   O mesmo se aplica para o delete com o kubectl delete.\nAutomatizando o processo de testes e deploy com um pipeline de CI/CD O Google KMS é um serviço quer permite gerenciar chaves criptográficas. Com ele podemos criptografar arquivos de configuração/environment variables e até adicioná-los ao controle de versão de forma segura, pois estarão criptografados.\nApós ativar a API do KMS, crie um grupo de chaves:\n1  gcloud kms keyrings create yourkeyringname --location global   Crie uma chave:\n1  gcloud kms keys create yourkeyname --location global --keyring yourkeyringname --purpose encryption   Criptografe os arquivos de configuração/environment variables que deseja:\n1 2 3 4  gcloud kms encrypt --location global \\  --keyring yourkeyringname --key yourkeyname \\  --plaintext-file .env.prod \\  --ciphertext-file .env.prod.enc   1 2 3 4  gcloud kms encrypt --location global \\  --keyring yourkeyringname --key yourkeyname \\  --plaintext-file cloudsqlproxy.json \\  --ciphertext-file cloudsqlproxy.json.enc    O exemplo abaixo é necessário apenas se possui algum pacote privado como o Laravel Nova.\n 1 2 3 4  gcloud kms encrypt --location global \\  --keyring yourkeyringname --key yourkeyname \\  --plaintext-file auth.json \\  --ciphertext-file auth.json.enc   Agora ambos podem ser commitados de forma segura :)\nUtilizo o Cloud Build para o processo de CI/CD, separo os processos em duas triggers e dois arquivos: cloudbuild.ci.yaml e cloudbuild.cd.yaml. Lembre-se de adicionar as variáveis de substituição nas triggers criadas no Cloud Build:\n _CLUSTER - o nome do seu cluster _KEY - sua chave kms criada anteriormente _KEYRING - seu keyring criado anteriormente _ZONE - yourregion-zone  cloudbuild.ci.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55  steps:- id:\"Decrypt auth.json\"name:gcr.io/cloud-builders/gcloudargs:- kms- decrypt- --ciphertext-file=auth.json.enc- --plaintext-file=auth.json- --location=global- --keyring=$_KEYRING- --key=$_KEY- id:\"Copy .env file\"name:gcr.io/cloud-builders/gsutilargs:[\"cp\",\".env.testing\",\".env\"]- id:\"Up\"name:docker/compose:1.24.0args:[\"-f\",\"docker-compose.testing.yml\",\"up\",\"-d\",\"app\"]- id:\"Install dependencies\"name:gcr.io/cloud-builders/dockerargs:[\"exec\",\"-t\",\"app\",\"composer\",\"install\",\"--no-interaction\",\"--no-ansi\",\"--no-progress\",\"--prefer-dist\",\"--optimize-autoloader\",]- id:\"Duplicated code analysis\"name:gcr.io/cloud-builders/dockerwaitFor:[\"Install dependencies\"]args:[\"exec\",\"-t\",\"app\",\"composer\",\"phpcpd\"]- id:\"Lint analysis\"name:gcr.io/cloud-builders/dockerwaitFor:[\"Install dependencies\"]args:[\"exec\",\"-t\",\"app\",\"composer\",\"lint\"]- id:\"Code quality and code style analysis\"name:gcr.io/cloud-builders/dockerwaitFor:[\"Install dependencies\"]args:[\"exec\",\"-t\",\"app\",\"composer\",\"insights\"]- id:\"Run tests\"name:gcr.io/cloud-builders/dockerwaitFor:[\"Install dependencies\"]args:[\"exec\",\"-t\",\"app\",\"composer\",\"test\"]  cloudbuild.cd.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105  steps:- id:\"Decrypt .env\"name:gcr.io/cloud-builders/gcloudargs:- kms- decrypt- --ciphertext-file=.env.prod.enc- --plaintext-file=.env- --location=global- --keyring=$_KEYRING- --key=$_KEY- id:\"Decrypt cloudsqlproxy.json service account\"name:gcr.io/cloud-builders/gcloudargs:- kms- decrypt- --ciphertext-file=cloudsqlproxy.json.enc- --plaintext-file=cloudsqlproxy.json- --location=global- --keyring=$_KEYRING- --key=$_KEY- id:\"Decrypt auth.json\"name:gcr.io/cloud-builders/gcloudargs:- kms- decrypt- --ciphertext-file=auth.json.enc- --plaintext-file=auth.json- --location=global- --keyring=$_KEYRING- --key=$_KEY- id:\"Create env secret manifest\"name:gcr.io/cloud-builders/kubectlwaitFor:[\"Decrypt .env\"]entrypoint:/bin/shargs:- -c- |kubectl create secret generic env --from-env-file .env --dry-run -n yourapp1 -o yaml  k8s/06.0-app-secret.yamlenv:- \"CLOUDSDK_COMPUTE_ZONE=$_ZONE\"- \"CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER\"- id:\"Create cloudsqlproxy secret manifest\"name:gcr.io/cloud-builders/kubectlwaitFor:[\"Decrypt cloudsqlproxy.json service account\"]entrypoint:/bin/shargs:- -c- |kubectl create secret generic cloudsql-instance-credentials --from-file=cloudsqlproxy.json=./cloudsqlproxy.json --dry-run -n yourapp1 -o yaml  k8s/06.1-cloudsqlproxy.yamlenv:- \"CLOUDSDK_COMPUTE_ZONE=$_ZONE\"- \"CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER\"- id:\"Build docker image\"name:gcr.io/cloud-builders/dockerargs:[\"build\",\"--build-arg\",\"COMPOSER_FLAGS=--prefer-dist --classmap-authoritative --no-dev\",\"-t\",\"gcr.io/$PROJECT_ID/yourapp1:$TAG_NAME\",\"-t\",\"gcr.io/$PROJECT_ID/yourapp1:latest\",\".\",]- id:\"Push docker image\"name:gcr.io/cloud-builders/dockerargs:[\"push\",\"gcr.io/$PROJECT_ID/yourapp1\"]- id:\"Set manifests image TAG_NAME\"name:gcr.io/cloud-builders/gcloudentrypoint:/bin/shargs:- \"-c\"- |sed -i 's/TAG_NAME/$TAG_NAME/g' k8s/06-app-deployment.yaml sed -i 's/TAG_NAME/$TAG_NAME/g' k8s/09-queue-deployment.yaml sed -i 's/TAG_NAME/$TAG_NAME/g' k8s/11-schedule-deployment.yaml- id:\"Deploy\"name:gcr.io/cloud-builders/gke-deployargs:[\"apply\",\"-f\",\"k8s/\",\"--cluster\",\"$_CLUSTER\",\"--location\",\"$_ZONE\"]- id:\"Copy assets to bucket\"name:gcr.io/cloud-builders/gsutilwaitFor:[\"-\"]args:[\"-h\",\"Cache-Control:public,max-age=31536000\",\"-m\",\"cp\",\"-r\",\"-Z\",\"public/*\",\"gs://yourapp1bucket\",]  Não vou entrar em detalhes sobre o processo de CI em cloudbuild.ci.yaml pois não é o propósito. Em resumo sobre o processo de CD em cloudbuild.cd.yaml:\n Os arquivos de configuração/environment variables são descriptografados. A criação secret env utilizada nos manifestos de 06-app-deployment, 09-queue-deployment e 11-schedule-deployment é simulada com --dry-run a partir do arquivo .env que foi descriptografado e seu output é salvo em k8s/06.0-app-secret.yaml. O mesmo processo ser repete para a service account utilizada para que o cloudsqlproxy tenha acesso ao Cloud SQL. A imagem docker é criada e tageada com a release tag do repositório e também com a tag latest. A palavra TAG_NAME é substituída pela release tag do repositório nos arquivos de manifesto. O deploy dos manifestos é realizado. Os assets da aplicação são copiados para um bucket.   Dica: Caso queira que um commit não passe pelo processo de CI/CD, adicione [skip cd] à mensagem de commit.\n Monitorando o cluster com Kontena Lens e métricas Prometheus Usando a api do kubernetes é possível obter vários dados para monitorar o cluster, porém para uma visão gráfica geral de todos os namespaces utilizo o Kontena Lens, uma ferramenta grátis e opensource:\nApós instalá-lo e conectá-lo ao cluster, clique com o botão direito no ícone do cluster e habilite as métricas prometheus.\nAnalise ao longo do tempo se as requests e os limits definidos nos deployments estão sendo suficientes ou até mesmo se estão desperdiçando recurso e redefina-os caso necessário.\nRealizando o deploy de outras aplicações O processo de deploy das outras aplicações é o mesmo, o namespace é diferente, mas os conceitos são os mesmos. Como um rápido exemplo, a quinta aplicação mencionada no início (executada no cloud.run), desta vez com um container apache:\nExemplo do app-deployment:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47  apiVersion:apps/v1kind:Deploymentmetadata:name:appnamespace:yourapp2labels:name:appannotations:secret.reloader.stakater.com/reload:\"env\"spec:replicas:1revisionHistoryLimit:1selector:matchLabels:name:appstrategy:type:RollingUpdaterollingUpdate:maxSurge:1maxUnavailable:50%template:metadata:labels:name:appspec:containers:- name:appimage:gcr.io/yourproject/yourapp2:TAG_NAMEcommand:[\"/bin/bash\"]args:- -c- |php artisan optimize php artisan view:cache apache2-foregroundenvFrom:- secretRef:name:envports:- containerPort:8080resources:requests:cpu:50mmemory:256Milimits:cpu:100mmemory:256Mi  Problemas identificados Aqui vão algumas dicas para que alguém que esteja lendo não passe pelas mesmas situações que passei:\nAtive o Network Plugin do GKE Durante as primeiras semanas me deparava com uma mensagem “network is not ready: runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady” e os pods reinicializando uma ou duas vezes na semana. A solução é ativar o Network plugin do GKE, que utiliza o Calico por trás dos panos.\nReduza os recursos utilizado pelo namespace kube-system Por padrão o GKE declara um limit de 1 vCPU para o fluentd utilizado na captura de logs, esse limite está exagerado para um cluster pequeno como o nosso. Abaixo uma ScalingPolicy das requests and limits do fluentd:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  apiVersion:scalingpolicy.kope.io/v1alpha1kind:ScalingPolicymetadata:name:fluentd-gcp-scaling-policynamespace:kube-systemspec:containers:- name:fluentd-gcpresources:requests:- resource:cpubase:15m- resource:memorybase:198Milimits:- resource:cpubase:20m- resource:memorybase:256Mi  980m de cpu a menos do que o padrão definido pelo GKE 😅\nAplique o arquivo acima:\n1  kubectl apply -f fluentd-gcp-scaling-policy.yaml   Outras dicas para reduzir recursos consumidos pelo namespace kube-system podem ser encontradas aqui.\nCusto de forwading rules no load balancer Como dito anteriormente, entre 1 e 5 forwarding rules o custo é o mesmo, aproximadamente 18 USD. Porém, após o deploy de 5 aplicações temos 10 fowarding rules, totalizando mais de 50 USD…\nPossíveis soluções:\n  Com custo aproximado de 18 USD: Utilizar apenas um load balancer no namespace default com nginx realizando o proxy para os serviços em diferentes namespaces, gerando assim apenas duas forwarding rules. Exemplo de um nginx-configmap para atingir esse objetivo:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41  apiVersion:v1kind:ConfigMapmetadata:name:nginx-configmapnamespace:defaultdata:default.conf:|server { listen 80; listen [::]:80; server_name _; location / { add_header Content-Type text/plain; return 200 \"OK.\"; } } server { listen 80; listen [::]:80; server_name yourapp1.com www.yourapp1.com; location / { proxy_set_header Host $host; proxy_set_header X-Forwarded-For $remote_addr; proxy_pass http://nginx.yourapp1.svc.cluster.local:80; } } server { listen 80; listen [::]:80; server_name yourapp2.com www.yourapp2.com; location / { proxy_set_header Host $host; proxy_set_header X-Forwarded-For $remote_addr; proxy_pass http://app.yourapp2.svc.cluster.local:8080; } }  Vantagens:\n Sua aplicação continua utilizando o load balancer do Google. Os certificados SSL auto gerenciados pelo Google ainda funcionam.  Desvantagens:\n 18 USD 😅    Com custo 0 USD: Nginx Ingress, Traefik, Istio ou outro ingress.\nVantagens:\n 0 USD Features não disponíveis no ingress padrão do Google.  Desvantagens:\n Aparentemente, bem mais trabalhoso (minha opinião).    Próximos passos O processo ao longo dos dias foi bem divertido, agora continuarei monitorando e aprimorando o conhecimento na ferramenta. Se lhe ajudou ou se tem sugestões, deixe um comentário abaixo :)\nConteúdos que me ajudaram no processo:\n https://kubernetes.io https://www.k8sref.io https://itsmetommy.com https://k8s.af  Último recado:\nSó se aventure com Kubernetes para aprendizado ou se fizer sentido para seu projeto e resolver algum problema existente como foi mostrado nesse artigo. Não complique o que está funcionando perfeitamente.\n","wordCount":"4771","inLanguage":"pt","datePublished":"2020-03-29T13:29:17-03:00","dateModified":"2021-02-28T13:29:00-03:00","author":{"@type":"Person","name":"Bruno Tomé"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://ibrunotome.github.io/multiplas-aplicacoes-em-um-cluster-kubernetes/"},"publisher":{"@type":"Organization","name":"Bruno Tomé","logo":{"@type":"ImageObject","url":"https://ibrunotome.github.io/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://ibrunotome.github.io accesskey=h title="Bruno Tomé (Alt + H)">Bruno Tomé</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://ibrunotome.github.io/en/ title=English aria-label=English>English</a></li></ul></span></div><ul id=menu onscroll=menu_on_scroll()><li><a href=https://ibrunotome.github.io/categories/ title=categorias><span>categorias</span></a></li><li><a href=https://ibrunotome.github.io/tags/ title=tags><span>tags</span></a></li><li><a href=https://ibrunotome.github.io/sobre/ title=sobre><span>sobre</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Múltiplas aplicações em um cluster Kubernetes</h1><div class=post-meta>March 29, 2020&nbsp;·&nbsp;Bruno Tomé
&nbsp;|&nbsp;<ul class=i18n_list>Translations:<li><a href=https://ibrunotome.github.io/en/multiple-applications-in-one-kubernetes-cluster/>English</a></li></ul></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><div class=details>Table of Contents</div></summary><div class=inner><ul><li><a href=#o-problema-inicial aria-label="O problema inicial">O problema inicial</a></li><li><a href=#por-que-kubernetes aria-label="Por que Kubernetes?">Por que Kubernetes?</a></li><li><a href=#criando-o-cluster-kubernetes aria-label="Criando o cluster Kubernetes">Criando o cluster Kubernetes</a></li><li><a href=#preparando-os-containers aria-label="Preparando os containers">Preparando os containers</a></li><li><a href=#preparando-os-manifestos aria-label="Preparando os manifestos">Preparando os manifestos</a><ul><ul><ul><ul><li><a href=#01-namespaceyaml aria-label=01-namespace.yaml>01-namespace.yaml</a></li><li><a href=#02-nfs-server-deploymentyaml aria-label=02-nfs-server-deployment.yaml>02-nfs-server-deployment.yaml</a></li><li><a href=#03-nfs-server-serviceyaml aria-label=03-nfs-server-service.yaml>03-nfs-server-service.yaml</a></li><li><a href=#04-redis-statefulsetyaml aria-label=04-redis-statefulset.yaml>04-redis-statefulset.yaml</a></li><li><a href=#05-redis-serviceyaml aria-label=05-redis-service.yaml>05-redis-service.yaml</a></li><li><a href=#06-app-deploymentyaml aria-label=06-app-deployment.yaml>06-app-deployment.yaml</a></li><li><a href=#07-app-hpayaml aria-label=07-app-hpa.yaml>07-app-hpa.yaml</a></li><li><a href=#08-app-serviceyaml aria-label=08-app-service.yaml>08-app-service.yaml</a></li><li><a href=#09-queue-deploymentyaml aria-label=09-queue-deployment.yaml>09-queue-deployment.yaml</a></li><li><a href=#10-queue-hpayaml aria-label=10-queue-hpa.yaml>10-queue-hpa.yaml</a></li><li><a href=#11-schedule-deploymentyaml aria-label=11-schedule-deployment.yaml>11-schedule-deployment.yaml</a></li><li><a href=#12-nginx-configmapyaml aria-label=12-nginx-configmap.yaml>12-nginx-configmap.yaml</a></li><li><a href=#13-nginx-deploymentyaml aria-label=13-nginx-deployment.yaml>13-nginx-deployment.yaml</a></li><li><a href=#14-nginx-hpayaml aria-label=14-nginx-hpa.yaml>14-nginx-hpa.yaml</a></li><li><a href=#15-nginx-serviceyaml aria-label=15-nginx-service.yaml>15-nginx-service.yaml</a></li><li><a href=#16-managedcertsyaml aria-label=16-managedcerts.yaml>16-managedcerts.yaml</a></li><li><a href=#17-ingressyaml aria-label=17-ingress.yaml>17-ingress.yaml</a></li></ul></ul></ul></ul></li><li><a href=#adicionando-certificados-ssl-auto-gerenciados aria-label="Adicionando certificados SSL auto gerenciados">Adicionando certificados SSL auto gerenciados</a></li><li><a href=#realizando-o-deploy-dos-manifestos aria-label="Realizando o deploy dos manifestos">Realizando o deploy dos manifestos</a></li><li><a href=#automatizando-o-processo-de-testes-e-deploy-com-um-pipeline-de-cicd aria-label="Automatizando o processo de testes e deploy com um pipeline de CI/CD">Automatizando o processo de testes e deploy com um pipeline de CI/CD</a><ul><ul><ul><ul><li><a href=#cloudbuildciyaml aria-label=cloudbuild.ci.yaml>cloudbuild.ci.yaml</a></li><li><a href=#cloudbuildcdyaml aria-label=cloudbuild.cd.yaml>cloudbuild.cd.yaml</a></li></ul></ul></ul></ul></li><li><a href=#monitorando-o-cluster-com-kontena-lens-e-m%c3%a9tricas-prometheus aria-label="Monitorando o cluster com Kontena Lens e métricas Prometheus">Monitorando o cluster com Kontena Lens e métricas Prometheus</a></li><li><a href=#realizando-o-deploy-de-outras-aplica%c3%a7%c3%b5es aria-label="Realizando o deploy de outras aplicações">Realizando o deploy de outras aplicações</a></li><li><a href=#problemas-identificados aria-label="Problemas identificados">Problemas identificados</a><ul><ul><ul><ul><li><a href=#ative-o-network-plugin-do-gke aria-label="Ative o Network Plugin do GKE">Ative o Network Plugin do GKE</a></li><li><a href=#reduza-os-recursos-utilizado-pelo-namespace-kube-system aria-label="Reduza os recursos utilizado pelo namespace kube-system">Reduza os recursos utilizado pelo namespace kube-system</a></li><li><a href=#custo-de-forwading-rules-no-load-balancer aria-label="Custo de forwading rules no load balancer">Custo de forwading rules no load balancer</a></li></ul></ul></ul></ul></li><li><a href=#pr%c3%b3ximos-passos aria-label="Próximos passos">Próximos passos</a></li></ul></div></details></div><div class=post-content><p>Nesse artigo mostro como preparei múltiplas aplicações para deploy em um único cluster kubernetes e também: o motivo da
escolha do kubernetes, os benefícios, as dificuldades enfrentadas e os próximos passos.</p><h2 id=o-problema-inicial>O problema inicial<a hidden class=anchor aria-hidden=true href=#o-problema-inicial>#</a></h2><p>Temos pelo menos 5 aplicações principais rodando no <a href=https://cloud.google.com>Google Cloud Platform (GCP)</a> e também algumas funções que foram desacopladas de uma API e hoje são executadas a partir de <a href=https://cloud.google.com/functions>google functions</a>, acessadas pelas aplicações principais.</p><p>Três dessas aplicações principais rodavam individualmente (uma aplicação por VM) em VMs do tipo n1-standard-1 (1vCPU e 3,75GB de RAM). Todas as aplicações containerizadas e o deploy em produção realizado por um simples:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>docker-compose up -d
</code></pre></td></tr></table></div></div><p>Mesmo com todo o processo de deploy automatizado, sem gerar dores de cabeça, <code>o desperdício de recursos</code> por parte de duas aplicações e a <code>falta de recursos disponíveis</code> para uma das aplicações me incomodava:</p><ul><li>Uma das aplicações (painel de administração, poucas pessoas com acesso) consumia no máximo 20% da CPU somando
todos os containers (nginx, app, schedule, queue, redis, certbot) e no máximo 2 dos 3,75GB de RAM.</li><li>Uma segunda aplicação com métricas e situação bem parecida à mencionada acima.</li><li>Uma terceira aplicação, com situação oposta, com métricas recomendando o upgrade da VM para pelo menos 6GB
de RAM. Essa aplicação executa jobs em queues, pode ficar alguns minutos sem receber nenhum novo job, porém, quando recebe um novo job ela deve executar todos rapidamente, além de poder receber novos jobs enquanto executa o antigo e já ter que iniciar a execução desse novo job sem espera. No framework utilizado nessa aplicação (Laravel), cada worker utiliza pelo menos 32MB de RAM, se configurarmos um valor máximo de 120 workers, já são necessários pelo menos 3840MB de memória RAM, excedendo os 3,75GB de RAM dessa VM. Além do fato de muitas vezes os 120 workers não serem suficientes para uma entrega rápida, ocasionando em um wait time longo para executar os jobs nas queues:</li></ul><p><img src=../horizon-queue-long-wait-time.png alt="Longo tempo de espera para execução dos jobs no horizon"></p><p>Essa aplicação definivamente precisava de mais recursos enquanto as outras duas citadas anteriormente não utilizavam todos os recursos disponíveis.</p><ul><li><p>Uma quarta aplicação, um MVP (<em>Minimum viable product</em>) rodando em um único container no <a href=https://cloud.run>cloud.run</a>, já estava validada e precisava evoluir com implementação de queues e cache. Como o cloud.run é feito para conteúdo <em>stateless</em> e não possui acesso a redis (pelo menos não de forma fácil, sem ter que expor o redis de alguma VM por exemplo), era necessário tirá-lo dali.</p></li><li><p>Uma quinta aplicação, também em container único, rodava bem no cloud.run e, diferentemente da anterior não precisa de queues. Porém, como possui muitos acessos no cloud.run e o tempo de execução de CPU de cada request dessa aplicação é alto, os custos no cloud.run começaram a incomodar (abaixo os preços do cloud.run com e sem free tier):</p></li></ul><p><img src=../cloud-run-pricing.png alt="Cloud Run Pricing"></p><p>Uma solução viável para otimização da utilização de recursos seria executar as aplicações em um cluster, possuindo assim o controle de quanto hardware dedicar a cada aplicação e abrindo possibilidade para escalabilidade da terceira aplicação mencionada anteriormente. Para orquestrar os contâiners no cluster, dentre as opções disponíveis eu teria que escolher bem entre duas: Swarm ou Kubernetes, pois possuía um pouco de conhecimento prévio em ambas as ferramentas.</p><h2 id=por-que-kubernetes>Por que Kubernetes?<a hidden class=anchor aria-hidden=true href=#por-que-kubernetes>#</a></h2><p>Gerenciar um cluster é difícil, aplicar patches de segurança, auto reparo, auto upgrade, auto scaling e garantir
disponibilidade são só alguns dos exemplos do que teríamos que manter caso optássemos por gerenciá-lo.</p><p>Dentre as opções de cluster citadas anteriormente (Swarm e Kubernetes), nosso cloud provider disponibiliza apenas o serviço de gerenciamento de Kubernetes (na minha opinião, um dos melhores e mais robustos, talvez porque eles projetaram o Kubernetes e a maioria dos seus serviços rodam no mesmo). O serviço é o Google Kubernetes Engine (GKE) e <a href=https://cloud.google.com/kubernetes-engine#pricing>oferece um plano gratuito para um cluster zonal</a>, atendendo nossas necessidades.</p><p>Os custos previstos:</p><ul><li>2 VMs <a href=https://cloud.google.com/blog/products/compute/google-compute-engine-gets-new-e2-vm-machine-types>e2-standard-2</a> com 2vCPU e 8GB de ram cada, totalizando um cluster com 4vCPU e 16GB de RAM. Com um contrato de <a href=https://cloud.google.com/compute/docs/instances/signing-up-committed-use-discounts>desconto por uso contínuo</a> de 3 anos, a previsão mensal de custo é de aproximadamente <code>45 USD</code>.</li><li>Loadbalancer http/https, 1 até 5 regras de forwarding custam aproximadamente <code>18 USD</code>.</li></ul><p>Bancos de dados, buckets e outros serviços gerenciados do google não entram na conta pois não foram alterados e seus custos continuaram os mesmos.</p><h2 id=criando-o-cluster-kubernetes>Criando o cluster Kubernetes<a hidden class=anchor aria-hidden=true href=#criando-o-cluster-kubernetes>#</a></h2><p>Podemos criar o cluster no GKE pelo <a href=https://console.cloud.google.com/kubernetes/>Google Cloud Console</a> ou via linha de comando a partir de nossa máquina:</p><blockquote><p>Tenha o gcloud e kubectl previamente instalados.</p></blockquote><blockquote><p>Substitua <code>yourclustername</code>, <code>yourprojectname</code>, <code>yourregion</code> (ex para São Paulo: southamerica-east1), <code>yourregion-zone</code> (ex para São Paulo e zona a: southamerica-east1-a) e <code>yournetwork</code> pelos devidos valores.</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud container <span class=se>\
</span><span class=se></span>  clusters create <span class=s2>&#34;yourclustername&#34;</span> <span class=se>\
</span><span class=se></span>  --project <span class=s2>&#34;yourprojectname&#34;</span> <span class=se>\
</span><span class=se></span>  --zone <span class=s2>&#34;yourregion-zone&#34;</span> <span class=se>\
</span><span class=se></span>  --no-enable-basic-auth <span class=se>\
</span><span class=se></span>  --release-channel <span class=s2>&#34;regular&#34;</span> <span class=se>\
</span><span class=se></span>  --machine-type <span class=s2>&#34;e2-standard-2&#34;</span> <span class=se>\
</span><span class=se></span>  --image-type <span class=s2>&#34;COS&#34;</span> <span class=se>\
</span><span class=se></span>  --disk-type <span class=s2>&#34;pd-ssd&#34;</span> <span class=se>\
</span><span class=se></span>  --disk-size <span class=s2>&#34;20&#34;</span> <span class=se>\
</span><span class=se></span>  --metadata disable-legacy-endpoints<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --scopes <span class=s2>&#34;https://www.googleapis.com/auth/devstorage.read_only&#34;</span>,<span class=s2>&#34;https://www.googleapis.com/auth/logging.write&#34;</span>,<span class=s2>&#34;https://www.googleapis.com/auth/monitoring&#34;</span>,<span class=s2>&#34;https://www.googleapis.com/auth/servicecontrol&#34;</span>,<span class=s2>&#34;https://www.googleapis.com/auth/service.management.readonly&#34;</span>,<span class=s2>&#34;https://www.googleapis.com/auth/trace.append&#34;</span> <span class=se>\
</span><span class=se></span>  --num-nodes <span class=s2>&#34;2&#34;</span> <span class=se>\
</span><span class=se></span>  --enable-stackdriver-kubernetes <span class=se>\
</span><span class=se></span>  --enable-ip-alias <span class=se>\
</span><span class=se></span>  --network <span class=s2>&#34;projects/yourprojectname/global/networks/yournetwork&#34;</span> <span class=se>\
</span><span class=se></span>  --subnetwork <span class=s2>&#34;projects/yourprojectname/regions/yourregion/subnetworks/yournetwork&#34;</span> <span class=se>\
</span><span class=se></span>  --default-max-pods-per-node <span class=s2>&#34;110&#34;</span> <span class=se>\
</span><span class=se></span>  --enable-autoscaling <span class=se>\
</span><span class=se></span>  --min-nodes <span class=s2>&#34;2&#34;</span> <span class=se>\
</span><span class=se></span>  --max-nodes <span class=s2>&#34;3&#34;</span> <span class=se>\
</span><span class=se></span>  --no-enable-master-authorized-networks <span class=se>\
</span><span class=se></span>  --addons HorizontalPodAutoscaling,HttpLoadBalancing,NodeLocalDNS,ApplicationManager <span class=se>\
</span><span class=se></span>  --enable-autoupgrade <span class=se>\
</span><span class=se></span>  --enable-autorepair <span class=se>\
</span><span class=se></span>  --max-surge-upgrade <span class=m>1</span> <span class=se>\
</span><span class=se></span>  --max-unavailable-upgrade <span class=m>0</span> <span class=se>\
</span><span class=se></span>  --enable-shielded-nodes
</code></pre></td></tr></table></div></div><p>Definimos que o cluster terá no mínimo 2 nodes com máquinas do tipo e2-standard-2 (máquinas contratadas no commitment discount mencionado anteriormente), e no máximo 3 nodes.</p><p>Altere o contexto do <code>kubectl</code> para o GKE:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl config set-context gke_yourprojectname_yourregion-zone_yourclustername
</code></pre></td></tr></table></div></div><h2 id=preparando-os-containers>Preparando os containers<a hidden class=anchor aria-hidden=true href=#preparando-os-containers>#</a></h2><p>Como dito no primeiro tópico, as aplicações já rodavam containerizadas. Um container dedicado para a aplicação web, um para as queues, um para a execução de schedules, um container redis e um nginx. O container certbot foi descartado pois foi adotada outra abordagem para gerenciamento dos certificados SSL.</p><p>Caso você ainda não tenha containerizado sua aplicação, prepare-a de modo que respeite o <a href=https://12factor.net>Twelve-Factor App</a>.</p><h2 id=preparando-os-manifestos>Preparando os manifestos<a hidden class=anchor aria-hidden=true href=#preparando-os-manifestos>#</a></h2><p>Aqui vem o primeiro susto para quem era acostumado a subir o ambiente de produção inteiro com um único arquivo
docker-compose.yaml 🙃</p><p><img src=../k8s-first-application-manifests.png alt="Manifestos k8s"></p><p>Mostrarei o propósito de cada arquivo. Veja detalhes e conceitos do Kubernetes em sua <a href=https://kubernetes.io/docs/concepts/>documentação</a>.</p><p>A infraestrutura da aplicação é definida como código, os controllers do Kubernetes checam em loop <code>se o estado atual da aplicação é igual ao estado definido via código</code>, e caso não seja, aplica as modificações necessárias.</p><p>Os manifestos podem ser definidos em YAML ou JSON, as extensões <code>.yaml</code>, <code>.yml</code> e <code>.json</code> são aceitas. Coloco todos no mesmo diretório para facilitar o deploy com o comando:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f k8s/
</code></pre></td></tr></table></div></div><h6 id=01-namespaceyaml>01-namespace.yaml<a hidden class=anchor aria-hidden=true href=#01-namespaceyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>resource-quota</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>requests.cpu</span><span class=p>:</span><span class=w> </span><span class=l>300m</span><span class=w>
</span><span class=w>    </span><span class=nt>requests.memory</span><span class=p>:</span><span class=w> </span><span class=l>1536Mi</span><span class=w>
</span><span class=w>    </span><span class=nt>limits.cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span><span class=w>    </span><span class=nt>limits.memory</span><span class=p>:</span><span class=w> </span><span class=l>2048Mi</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Nesse arquivo defino o <a href=https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/>Namespace</a> da aplicação. Com namespaces é possível definir o escopo das aplicações. Assim é possível executar várias aplicações diferentes no mesmo cluster sem que interfiram uma na outra (a comunicação entre namespaces ainda é possível através de serviços expostos como mostrarei). Outra utilidade de namespaces é separar ambientes de <code>staging</code> e <code>production</code> por exemplo. Por padrão, caso namespaces não sejam definidos os deploys são realizados no namespace <code>default</code>.</p><p>No mesmo arquivo defino um deploy do tipo <a href=https://kubernetes.io/docs/concepts/policy/resource-quotas/>Resource Quota</a>, nele é possível definir os recursos e limites de recursos solicitados pelo namespace. No exemplo, defino que:</p><ul><li><p><code>requests.cpu: 300m</code> - todos os componentes do namespace somados podem requisitar (somados) no máximo 300 millicores de cpu (1vCPU = 1000m, valores de cpu podem ser definidos a partir de 1m).</p></li><li><p><code>requests.memory: 1536Mi</code> - todos os componentes do namespace somados podem requisitar (somados) no máximo 1536Mi de memória (1 Mebibyte (MiB) = (1024)^2 bytes = 1048576 bytes).</p></li><li><p><code>limits.cpu: 500m</code> - todos os componentes do namespace somados (apesar de poderem requisitar 300m de cpu definidos anteriormente) podem utilizar o máximo 500 millicores de cpu.</p></li><li><p><code>limits.memory: 2048Mi</code> - todos os componentes do namespace somados (apesar de poderem requisitar 1536Mi de memória definidos anteriormente) podem utilizar no máximo 2048Mi de memória.</p></li></ul><p>Quando os limites de cpu definidos são atingidos, a aplicação começa a sofrer <code>throttled</code> de cpu, ou seja, sua performance é afetada.</p><p>Quando os limites de memória são atingidos, não é possível &ldquo;comprimir&rdquo; a memória como é feito com cpu, e seu <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/>Pod</a> é terminado.</p><p>Quando um deploy de uma nova versão da sua aplicação é feita, caso o limite de cpu ou memória seja excedido, os pods não serão executados e ficarão com o estado <a href=https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#eviction-policy>Evicted</a>.</p><p>A definição de ResourceQuota para um namespace é opcional, porém garante que uma aplicação não consuma recursos demasiadamente.</p><h6 id=02-nfs-server-deploymentyaml>02-nfs-server-deployment.yaml<a hidden class=anchor aria-hidden=true href=#02-nfs-server-deploymentyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/google_containers/volume-nfs:latest</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span><span class=w>              </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>2049</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mountd</span><span class=w>
</span><span class=w>              </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>20048</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rpcbind</span><span class=w>
</span><span class=w>              </span><span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>111</span><span class=w>
</span><span class=w>          </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>168Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>192Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/exports</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span><span class=w>          </span><span class=nt>gcePersistentDisk</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>pdName</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1-nfs-disk</span><span class=w>
</span><span class=w>            </span><span class=nt>fsType</span><span class=p>:</span><span class=w> </span><span class=l>ext4</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Nesse arquivo defino o deployment de um volume NFS, já que o padrão <a href=https://kubernetes.io/docs/concepts/storage/persistent-volumes/#access-modes>GCEPersistentDisk</a> do GKE não suporta o tipo de acesso <code>ReadWriteMany</code> para ser lido e escrito por vários nodes ao mesmo tempo.</p><p>Este volume será usado para persistir os dados do redis e também as páginas estáticas que são geradas a partir do container app e compartilhadas com o container nginx.</p><p>Alguns detalhes do arquivo:</p><ul><li>O namespace deve ser o mesmo definido anteriormente para que o escopo do deploy seja o mesmo namespace.</li><li>Ele possui apenas uma réplica.</li><li>As requests e limits de cpu desse deployment podem ser bem pequenas (mostro mais a frente como analisar).</li><li>O volume é montado no path /exports do disco.</li><li>O disco definido em <code>pdName</code> nos volumes deve ser criado anteriormente com:</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud compute disks create --size<span class=o>=</span>1GB --zone<span class=o>=</span>yourregion-zone --type<span class=o>=</span>pd-ssd yourapp1-nfs-disk
</code></pre></td></tr></table></div></div><h6 id=03-nfs-server-serviceyaml>03-nfs-server-service.yaml<a hidden class=anchor aria-hidden=true href=#03-nfs-server-serviceyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>2049</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mountd</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>20048</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>rpcbind</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>111</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>O service acima é o responsável por <a href=https://kubernetes.io/docs/concepts/services-networking/service/>expor o deployment criado anteriormente para ser acessado pelos outros pods</a>. O serviço é exposto com ClusterIp, apenas para outros pods, e não para a internet.</p><p>Lembre-se de definir o <code>selector</code> do service com o mesmo valor definido nas <code>labels</code> do selector no deployment.</p><h6 id=04-redis-statefulsetyaml>04-redis-statefulset.yaml<a hidden class=anchor aria-hidden=true href=#04-redis-statefulsetyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>redis:5.0.5-alpine</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>14Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>5m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server.yourapp1.svc.cluster.local</span><span class=w>
</span><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/redis/data&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>O deploy do redis é do tipo <a href=https://kubernetes.io/docs/concepts/workloads/controllers/statefulset/>StatefulSet</a>, o volume pode acessar diretamente o serviço deployado anteriormente via <code>&lt;service></code>.<code>&lt;namespace></code>.svc.cluster.local.</p><h6 id=05-redis-serviceyaml>05-redis-service.yaml<a hidden class=anchor aria-hidden=true href=#05-redis-serviceyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>6379</span><span class=w>
</span><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>redis</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Expõe o redis com ClusterIp para ser acessado pelos outros pods.</p><h6 id=06-app-deploymentyaml>06-app-deployment.yaml<a hidden class=anchor aria-hidden=true href=#06-app-deploymentyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>secret.reloader.stakater.com/reload</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=l>%</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/yourproject/yourapp1:TAG_NAME</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span><span class=w>            </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>              sleep 12
</span><span class=sd>              php artisan migrate --force
</span><span class=sd>              php artisan optimize
</span><span class=sd>              php artisan view:cache
</span><span class=sd>              ln -s public html
</span><span class=sd>              ln -s /var/www /usr/share/nginx
</span><span class=sd>              /usr/local/sbin/php-fpm</span><span class=w>              
</span><span class=w>          </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env</span><span class=w>
</span><span class=w>          </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>            </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span><span class=w>            </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>            </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9000</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>9000</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>20m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>320Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>static</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/static</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-html</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/www/public/cache-html</span><span class=w>
</span><span class=w>          </span><span class=nt>lifecycle</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>postStart</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;cp -r /var/www/public/. /static&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-proxy</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloudsql-docker/gce-proxy:latest</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=p>[</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;/cloud_sql_proxy&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-instances=yourproject:cloudsql-region:yourproject=tcp:5432&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-credential_file=/secrets/cloudsql/cloudsqlproxy.json&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>8Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/secrets/cloudsql</span><span class=w>
</span><span class=w>              </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>static</span><span class=w>
</span><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server.yourapp1.svc.cluster.local</span><span class=w>
</span><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/static&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-html</span><span class=w>
</span><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server.yourapp1.svc.cluster.local</span><span class=w>
</span><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/cache-html&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span><span class=w>          </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Responsável pelo deploy da aplicação laravel com fpm, em <code>annotations</code> temos uma anotação <code>secret.reloader.stakater.com/reload: "env"</code> que irá realizar o deploy de um novo pod <code>sempre que a secret com nome env</code> for atualizada. Esse comportamento não é padrão do kubernetes e para habilitá-lo instalamos um controller chamado <a href=https://github.com/stakater/Reloader>Reloader</a> com o comando:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f https://raw.githubusercontent.com/stakater/Reloader/master/deployments/kubernetes/reloader.yaml
</code></pre></td></tr></table></div></div><ul><li><code>replicas: 2</code> - definimos que o deploy irá criar 2 pods.</li><li><code>revisionHistoryLimit: 1</code> - só teremos acesso a uma versão anterior a atual para rollback.</li></ul><p>Em <code>strategy</code>:</p><ul><li><code>type: RollingUpdate</code> - Nosso deploy é do tipo <a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-update-deployment>Rolling Update</a>.</li><li><code>maxSurge: 1</code> - Só pode surgir um novo pod por vez.</li><li><code>maxUnavailable: 50%</code> - No mínimo metade dos pods devem estar disponíveis durante o deploy, ou seja, no exemplo com <code>replicas: 2</code> e <code>maxSurge: 1</code>, um novo pod surgirá, então um pod antigo será terminado (respeitando o <code>maxUnavailable: 50%</code>), então um novo pod surgirá, e o último pod antigo será terminado.</li></ul><p>Em <code>containers</code>:</p><p>Esse pod possui 2 containers, o app principal e um sidecar (um proxy para conexão com o banco de dados no Google Cloud SQL).</p><p>No primeiro container <code>app</code> temos:</p><ul><li><code>commands:</code> e <code>args:</code> - são os comandos que serão executados pelo nosso container, o <code>sleep</code> inicial serve para aguardar até que o container sidecar esteja disponível. Na versão <code>1.18</code> em diante <a href=https://banzaicloud.com/blog/k8s-sidecars/>esse sleep não será mais necessário</a>.</li><li><code>envFrom:</code> - injetamos nossas variáveis de ambiente (mostrarei como criá-las no tópico <a href=#automatizando-o-processo-de-testes-e-deploy-com-um-pipeline-de-cicd>Automatizando o processo de teste e deploy com um pipeline CI/CD</a>).</li><li><code>readinessProbe:</code> - O container só receberá tráfego após uma conexão TCP bem sucedida com o container na porta 9000.</li><li><code>volumeMounts:</code> - O volume static compartilha assets entre o app e o nginx. O volume cache-html armazena algumas páginas de forma estática geradas a partir do conteúdo dinâmico, evitando a renderização a todo momento.</li></ul><p>No sidecar container <code>cloudsql-proxy</code> fazemos a autenticação com o uso de um secret que também mostro como criá-la no tópico <a href=#automatizando-o-processo-de-testes-e-deploy-com-um-pipeline-de-cicd>Automatizando o processo de teste e deploy com um pipeline CI/CD</a>.</p><h6 id=07-app-hpayaml>07-app-hpa.yaml<a hidden class=anchor aria-hidden=true href=#07-app-hpayaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>        </span><span class=nt>targetAverageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span><span class=w>        </span><span class=nt>targetAverageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>O <a href=https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/>Horizontal Pod Autoscaler (HPA)</a> escala automaticamente o número de pods do nosso deployment. No exemplo em <a href=06-app-deploymentyaml>06-app-deployment.yaml</a>, nosso deployment foi feito com duas réplicas, o HPA acima irá escalar esse deployment para 1 ou 3 réplicas baseado na média de utilização de cpu e memória do deployment.</p><h6 id=08-app-serviceyaml>08-app-service.yaml<a hidden class=anchor aria-hidden=true href=#08-app-serviceyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9000</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Expõe o app com ClusterIp para ser acessado pelos outros pods.</p><h6 id=09-queue-deploymentyaml>09-queue-deployment.yaml<a hidden class=anchor aria-hidden=true href=#09-queue-deploymentyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>secret.reloader.stakater.com/reload</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=l>%</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/yourproject/yourapp1:TAG_NAME</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span><span class=w>            </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>              php artisan config:cache
</span><span class=sd>              php artisan horizon --quiet</span><span class=w>              
</span><span class=w>          </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>150m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-proxy</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloudsql-docker/gce-proxy:latest</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=p>[</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;/cloud_sql_proxy&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-instances=yourproject:cloudsql-region:yourproject=tcp:5432&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-credential_file=/secrets/cloudsql/cloudsqlproxy.json&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>8Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/secrets/cloudsql</span><span class=w>
</span><span class=w>              </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span><span class=w>          </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Os conceitos são os mesmos do <a href=#06-app-deploymentyaml>06-app-deployment.yaml</a>, porém iniciamos com apenas uma réplica e o HPA a seguir controla a necessidade de outras réplicas.</p><h6 id=10-queue-hpayaml>10-queue-hpa.yaml<a hidden class=anchor aria-hidden=true href=#10-queue-hpayaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>queue</span><span class=w>
</span><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>        </span><span class=nt>targetAverageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span><span class=w>        </span><span class=nt>targetAverageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Os conceitos são os mesmos do <a href=#07-app-hpayaml>07-app-hpa.yaml</a>, porém para a queue.</p><h6 id=11-schedule-deploymentyaml>11-schedule-deployment.yaml<a hidden class=anchor aria-hidden=true href=#11-schedule-deploymentyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>schedule</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>schedule</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>secret.reloader.stakater.com/reload</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>schedule</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>schedule</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>schedule</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/yourproject/yourapp1:TAG_NAME</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span><span class=w>            </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>              php artisan config:cache
</span><span class=sd>              chmod +x schedule.sh
</span><span class=sd>              /var/www/schedule.sh</span><span class=w>              
</span><span class=w>          </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>10m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>8Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>30m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>64Mi</span><span class=w>
</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-proxy</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloudsql-docker/gce-proxy:latest</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=p>[</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;/cloud_sql_proxy&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-instances=yourproject:cloudsql-region:yourproject=tcp:5432&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-credential_file=/secrets/cloudsql/cloudsqlproxy.json&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>8Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>15m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/secrets/cloudsql</span><span class=w>
</span><span class=w>              </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span><span class=w>          </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>cloudsql-instance-credentials</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Se você já usa kubernetes provavelmente pensou &ldquo;existe um controller <a href=https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/>CronJob</a> para isso&rdquo;. Sim, porém meus crons são executados a cada minuto, o processo de um controller disparar um job, subir um pod, executar o container, matar o pod, e repetir de novo alguns segundos depois não me parece legal. <a href="https://youtu.be/MoIdU0J0f0E?t=939">Não sou o único a adotar essa abordagem para conjobs a cada minuto</a>.</p><h6 id=12-nginx-configmapyaml>12-nginx-configmap.yaml<a hidden class=anchor aria-hidden=true href=#12-nginx-configmapyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-configmap</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>nginx.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    user  nginx;
</span><span class=sd>    worker_processes  auto;
</span><span class=sd>
</span><span class=sd>    events {
</span><span class=sd>      worker_connections 4096;
</span><span class=sd>      multi_accept on;
</span><span class=sd>      use epoll;
</span><span class=sd>    }
</span><span class=sd>
</span><span class=sd>    http {
</span><span class=sd>      include       mime.types;
</span><span class=sd>      server_tokens off;
</span><span class=sd>      default_type  application/octet-stream;
</span><span class=sd>
</span><span class=sd>      client_body_buffer_size 10K;
</span><span class=sd>      client_header_buffer_size 1k;
</span><span class=sd>      client_max_body_size 10m;
</span><span class=sd>      large_client_header_buffers 4 16k;
</span><span class=sd>
</span><span class=sd>      access_log off;
</span><span class=sd>      error_log /dev/stderr;
</span><span class=sd>
</span><span class=sd>      sendfile on;
</span><span class=sd>
</span><span class=sd>      keepalive_timeout  65;
</span><span class=sd>      keepalive_requests 100;
</span><span class=sd>
</span><span class=sd>      log_format json_combined escape=json
</span><span class=sd>        &#39;{&#39;
</span><span class=sd>          &#39;&#34;time_local&#34;:&#34;$time_local&#34;,&#39;
</span><span class=sd>          &#39;&#34;remote_addr&#34;:&#34;$remote_addr&#34;,&#39;
</span><span class=sd>          &#39;&#34;remote_user&#34;:&#34;$remote_user&#34;,&#39;
</span><span class=sd>          &#39;&#34;request&#34;:&#34;$request&#34;,&#39;
</span><span class=sd>          &#39;&#34;status&#34;: &#34;$status&#34;,&#39;
</span><span class=sd>          &#39;&#34;body_bytes_sent&#34;:&#34;$body_bytes_sent&#34;,&#39;
</span><span class=sd>          &#39;&#34;request_time&#34;:&#34;$request_time&#34;,&#39;
</span><span class=sd>          &#39;&#34;http_referrer&#34;:&#34;$http_referer&#34;,&#39;
</span><span class=sd>          &#39;&#34;http_user_agent&#34;:&#34;$http_user_agent&#34;&#39;
</span><span class=sd>        &#39;}&#39;;
</span><span class=sd>
</span><span class=sd>      server {
</span><span class=sd>        listen 80;
</span><span class=sd>        server_name yourapp1.com www.yourapp1.com;
</span><span class=sd>        index index.php index.html;
</span><span class=sd>        root /usr/share/nginx/html;
</span><span class=sd>
</span><span class=sd>        if ($host = &#34;www.yourapp1.com&#34;) {
</span><span class=sd>          rewrite ^ https://yourapp1.com$request_uri? permanent;
</span><span class=sd>        }
</span><span class=sd>
</span><span class=sd>        if ($http_x_forwarded_proto = &#34;http&#34;) {
</span><span class=sd>          rewrite ^ https://yourapp1.com$request_uri? permanent;
</span><span class=sd>        }
</span><span class=sd>
</span><span class=sd>        add_header &#39;Referrer-Policy&#39; &#39;same-origin&#39;;
</span><span class=sd>        add_header &#39;Feature-Policy&#39; &#34;geolocation &#39;none&#39;; vibrate &#39;none&#39;&#34;;
</span><span class=sd>        add_header &#39;Strict-Transport-Security&#39; &#39;max-age=31536000; includeSubdomains; preload&#39;;
</span><span class=sd>        add_header &#39;X-Content-Type-Options&#39; &#39;nosniff&#39;;
</span><span class=sd>        add_header &#39;X-Frame-Options&#39; &#39;SAMEORIGIN&#39;;
</span><span class=sd>        add_header &#39;X-XSS-Protection&#39; &#39;1; mode=block&#39;;
</span><span class=sd>
</span><span class=sd>        gzip on;
</span><span class=sd>        gzip_disable &#34;MSIE [1-6]\.(?!.*SV1)&#34;;
</span><span class=sd>        gzip_vary on;
</span><span class=sd>        gzip_proxied any;
</span><span class=sd>        gzip_comp_level 6;
</span><span class=sd>        gzip_buffers 16 8k;
</span><span class=sd>        gzip_http_version 1.1;
</span><span class=sd>        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript text/x-js;
</span><span class=sd>
</span><span class=sd>        location ~* \.(js|jpg|jpeg|gif|png|css|tgz|gz|rar|bz2|doc|pdf|ppt|tar|wav|bmp|rtf|swf|ico|flv|txt|woff|woff2|svg|xml)$ {
</span><span class=sd>          root /static;
</span><span class=sd>          expires 365d;
</span><span class=sd>          access_log off;
</span><span class=sd>          etag on;
</span><span class=sd>          if_modified_since exact;
</span><span class=sd>          add_header Pragma &#34;public&#34;;
</span><span class=sd>          add_header Cache-Control &#34;max-age=31536000, public&#34;;
</span><span class=sd>          add_header Access-Control-Allow-Origin *;
</span><span class=sd>          try_files $uri =404;
</span><span class=sd>        }
</span><span class=sd>
</span><span class=sd>        location = / {
</span><span class=sd>          try_files /cache-html/index.html /index.php?$args;
</span><span class=sd>        }
</span><span class=sd>
</span><span class=sd>        location ~ ^/(comprar|blog|recompensas|avaliacoes-de-clientes|termos-de-servico|sobre-nos|politica-de-privacidade|politica-de-cancelamento).*$ {
</span><span class=sd>          try_files /cache-html/$uri.html$arg_page $uri $uri/ /index.php?$args;
</span><span class=sd>        }
</span><span class=sd>
</span><span class=sd>        location / {
</span><span class=sd>          try_files $uri $uri/ /index.php?$query_string;
</span><span class=sd>        }
</span><span class=sd>
</span><span class=sd>        location ~ \.php$ {
</span><span class=sd>          try_files $uri =404;
</span><span class=sd>          fastcgi_split_path_info ^(.+\.php)(/.+)$;
</span><span class=sd>          fastcgi_pass app:9000;
</span><span class=sd>          fastcgi_index index.php;
</span><span class=sd>          include fastcgi_params;
</span><span class=sd>          fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
</span><span class=sd>          fastcgi_param PATH_INFO $fastcgi_path_info;
</span><span class=sd>          fastcgi_read_timeout 180;
</span><span class=sd>          proxy_set_header Host            $http_host;
</span><span class=sd>          proxy_set_header X-Real-IP       $remote_addr;
</span><span class=sd>          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</span><span class=sd>        }
</span><span class=sd>      }
</span><span class=sd>    }</span><span class=w>    
</span></code></pre></td></tr></table></div></div><p>O <a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap</a> com a configuração nginx utilizada para essa aplicação.</p><h6 id=13-nginx-deploymentyaml>13-nginx-deployment.yaml<a hidden class=anchor aria-hidden=true href=#13-nginx-deploymentyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>configmap.reloader.stakater.com/reload</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;nginx-configmap&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.17-alpine</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=p>[</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;/bin/sh&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;-c&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>              </span><span class=s2>&#34;touch /usr/share/nginx/html/index.php; nginx -g &#39;daemon off;&#39;&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>            </span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>16Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>2m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>32Mi</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>          </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-configmap</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/nginx/nginx.conf</span><span class=w>
</span><span class=w>              </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>nginx.conf</span><span class=w>
</span><span class=w>              </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>static</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/static</span><span class=w>
</span><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-html</span><span class=w>
</span><span class=w>              </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/share/nginx/html/cache-html</span><span class=w>
</span><span class=w>
</span><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-configmap</span><span class=w>
</span><span class=w>          </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-configmap</span><span class=w>
</span><span class=w>            </span><span class=nt>items</span><span class=p>:</span><span class=w>
</span><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>nginx.conf</span><span class=w>
</span><span class=w>                </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>nginx.conf</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>static</span><span class=w>
</span><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server.yourapp1.svc.cluster.local</span><span class=w>
</span><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/static&#34;</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-html</span><span class=w>
</span><span class=w>          </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server.yourapp1.svc.cluster.local</span><span class=w>
</span><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/cache-html&#34;</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>O deployment do nginx utiliza o nfs-server criado no <a href=#02-nfs-server-deploymentyaml>passo 2</a> e exposto no <a href=#02-nfs-server-serviceyaml>passo 3</a>, ele terá acesso aos conteúdos compartilhados pelo <a href=#06-app-deploymentyaml>passo 6</a>. Além de utilizar o nginx-configmap criado no passo anterior.</p><h6 id=14-nginx-hpayaml>14-nginx-hpa.yaml<a hidden class=anchor aria-hidden=true href=#14-nginx-hpayaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>        </span><span class=nt>targetAverageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span><span class=w>    </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span><span class=w>      </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span><span class=w>        </span><span class=nt>targetAverageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>90</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Os conceitos são os mesmos do <a href=#07-app-hpayaml>07-app-hpa.yaml</a>, porém para o nginx.</p><h6 id=15-nginx-serviceyaml>15-nginx-service.yaml<a hidden class=anchor aria-hidden=true href=#15-nginx-serviceyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>      </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Expõe o nginx com o tipo NodePort para que seja acessado pela internet.</p><h6 id=16-managedcertsyaml>16-managedcerts.yaml<a hidden class=anchor aria-hidden=true href=#16-managedcertsyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.gke.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ManagedCertificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1-com</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>yourapp1.com</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=nn>---</span><span class=w>
</span><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.gke.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ManagedCertificate</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>www-yourapp-com</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>domains</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=l>www.yourapp1.com</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Os certificados SSL auto gerenciados pelo Google. Mais detalhes no tópico <a href=#adicionando-certificados-ssl-auto-gerenciados>Adicionando certificados SSL auto gerenciados</a></p><h6 id=17-ingressyaml>17-ingress.yaml<a hidden class=anchor aria-hidden=true href=#17-ingressyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1beta1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>kubernetes.io/ingress.global-static-ip-name</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1-global-ip-name</span><span class=w>
</span><span class=w>    </span><span class=nt>networking.gke.io/managed-certificates</span><span class=p>:</span><span class=w> </span><span class=l>yourapp1-com,www-yourapp1-com</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span><span class=w>    </span><span class=nt>servicePort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Criaremos um ip global para ser utilizado pela aplicação:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud compute addresses create yourapp1-global-ip-name --global
</code></pre></td></tr></table></div></div><p>O ingress irá expor a aplicação para a internet. Em <code>annotations</code> adicionamos o nome do IP global criado acima e o nome dos certificados gerenciados criados no passo anterior. Em <code>spec</code> definimos que todas as requests serão encaminhadas para o serviço nginx na porta 80, criado em <a href=#15-nginx-serviceyaml>15-nginx-service.yaml</a>.</p><p>Por trás dos panos, um load balancer é criado com duas forwarding rules (http e https) apontando para esse ingress e sua <code>spec</code>.</p><h2 id=adicionando-certificados-ssl-auto-gerenciados>Adicionando certificados SSL auto gerenciados<a hidden class=anchor aria-hidden=true href=#adicionando-certificados-ssl-auto-gerenciados>#</a></h2><p>Crie uma zona DNS</p><p><a href=https://cloud.google.com/dns/docs/>https://cloud.google.com/dns/docs/</a></p><p>Aponte o NS em seu register domain para os mostrados na zona DNS criada acima.</p><p>Aponte o record A para o IP criado anteriormente em <a href=#17-ingressyaml>17-ingress.yaml</a>. Obtenha o IP com o comando:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud compute addresses <span class=se>\
</span><span class=se></span>  describe yourapp1-global-ip-name --global <span class=se>\
</span><span class=se></span>  --format<span class=o>=</span><span class=s1>&#39;value(address)&#39;</span>
</code></pre></td></tr></table></div></div><p>Veja com o comando <code>host yourapp1.com</code> se ele já está apontando para o IP criado anteriormente.</p><p>No processo de deploy, quando o arquivo <a href=#16-managedcertsyaml>16-managedcerts.yaml</a> for aplicado (<code>kubectl apply -f 16-managedcerts.yaml</code>), o processo de geração do certificado irá levar de 15 a 30 minutos.</p><h2 id=realizando-o-deploy-dos-manifestos>Realizando o deploy dos manifestos<a hidden class=anchor aria-hidden=true href=#realizando-o-deploy-dos-manifestos>#</a></h2><p>O deploy pode ser realizado por arquivo:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f 01-namespace.yaml
kubectl apply -f 02-nfs-server-deployment.yaml
</code></pre></td></tr></table></div></div><p>Ou todos os arquivos da pasta</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f k8s/
</code></pre></td></tr></table></div></div><p>O mesmo se aplica para o delete com o <code>kubectl delete</code>.</p><h2 id=automatizando-o-processo-de-testes-e-deploy-com-um-pipeline-de-cicd>Automatizando o processo de testes e deploy com um pipeline de CI/CD<a hidden class=anchor aria-hidden=true href=#automatizando-o-processo-de-testes-e-deploy-com-um-pipeline-de-cicd>#</a></h2><p>O <a href=https://cloud.google.com/kms>Google KMS</a> é um serviço quer permite gerenciar chaves criptográficas. Com ele podemos criptografar arquivos de configuração/environment variables e <code>até adicioná-los ao controle de versão</code> de forma segura, pois estarão criptografados.</p><p>Após <a href=https://console.developers.google.com/apis/library/cloudkms.googleapis.com>ativar a API do KMS</a>, crie um grupo de chaves:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud kms keyrings create yourkeyringname --location global
</code></pre></td></tr></table></div></div><p>Crie uma chave:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud kms keys create yourkeyname --location global --keyring yourkeyringname --purpose encryption
</code></pre></td></tr></table></div></div><p>Criptografe os arquivos de configuração/environment variables que deseja:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud kms encrypt --location global <span class=se>\
</span><span class=se></span>  --keyring yourkeyringname --key yourkeyname <span class=se>\
</span><span class=se></span>  --plaintext-file .env.prod <span class=se>\
</span><span class=se></span>  --ciphertext-file .env.prod.enc
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud kms encrypt --location global <span class=se>\
</span><span class=se></span>  --keyring yourkeyringname --key yourkeyname <span class=se>\
</span><span class=se></span>  --plaintext-file cloudsqlproxy.json <span class=se>\
</span><span class=se></span>  --ciphertext-file cloudsqlproxy.json.enc
</code></pre></td></tr></table></div></div><blockquote><p>O exemplo abaixo é necessário apenas se possui algum pacote privado como o <a href=https://nova.laravel.com>Laravel Nova</a>.</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>gcloud kms encrypt --location global <span class=se>\
</span><span class=se></span>  --keyring yourkeyringname --key yourkeyname <span class=se>\
</span><span class=se></span>  --plaintext-file auth.json <span class=se>\
</span><span class=se></span>  --ciphertext-file auth.json.enc
</code></pre></td></tr></table></div></div><p>Agora ambos podem ser commitados de forma segura :)</p><p>Utilizo o <a href=https://cloud.google.com/cloud-build/>Cloud Build</a> para o processo de CI/CD, separo os processos em duas <a href=https://console.cloud.google.com/cloud-build/triggers>triggers</a> e dois arquivos: <code>cloudbuild.ci.yaml</code> e <code>cloudbuild.cd.yaml</code>. Lembre-se de adicionar as <code>variáveis de substituição</code> nas triggers criadas no Cloud Build:</p><ul><li><code>_CLUSTER</code> - o nome do seu cluster</li><li><code>_KEY</code> - sua chave kms criada anteriormente</li><li><code>_KEYRING</code> - seu keyring criado anteriormente</li><li><code>_ZONE</code> - yourregion-zone</li></ul><h6 id=cloudbuildciyaml>cloudbuild.ci.yaml<a hidden class=anchor aria-hidden=true href=#cloudbuildciyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Decrypt auth.json&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gcloud</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>kms</span><span class=w>
</span><span class=w>      </span>- <span class=l>decrypt</span><span class=w>
</span><span class=w>      </span>- --<span class=l>ciphertext-file=auth.json.enc</span><span class=w>
</span><span class=w>      </span>- --<span class=l>plaintext-file=auth.json</span><span class=w>
</span><span class=w>      </span>- --<span class=l>location=global</span><span class=w>
</span><span class=w>      </span>- --<span class=l>keyring=$_KEYRING</span><span class=w>
</span><span class=w>      </span>- --<span class=l>key=$_KEY</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Copy .env file&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gsutil</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;cp&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;.env.testing&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;.env&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Up&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>docker/compose:1.24.0</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-f&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;docker-compose.testing.yml&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;up&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-d&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Install dependencies&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=p>[</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;exec&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;app&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;composer&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;install&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;--no-interaction&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;--no-ansi&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;--no-progress&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;--prefer-dist&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;--optimize-autoloader&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>      </span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Duplicated code analysis&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;Install dependencies&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;composer&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;phpcpd&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Lint analysis&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;Install dependencies&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;composer&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;lint&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Code quality and code style analysis&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;Install dependencies&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;composer&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;insights&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Run tests&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;Install dependencies&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;exec&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;app&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;composer&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;test&#34;</span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><h6 id=cloudbuildcdyaml>cloudbuild.cd.yaml<a hidden class=anchor aria-hidden=true href=#cloudbuildcdyaml>#</a></h6><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>steps</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Decrypt .env&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gcloud</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>kms</span><span class=w>
</span><span class=w>      </span>- <span class=l>decrypt</span><span class=w>
</span><span class=w>      </span>- --<span class=l>ciphertext-file=.env.prod.enc</span><span class=w>
</span><span class=w>      </span>- --<span class=l>plaintext-file=.env</span><span class=w>
</span><span class=w>      </span>- --<span class=l>location=global</span><span class=w>
</span><span class=w>      </span>- --<span class=l>keyring=$_KEYRING</span><span class=w>
</span><span class=w>      </span>- --<span class=l>key=$_KEY</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Decrypt cloudsqlproxy.json service account&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gcloud</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>kms</span><span class=w>
</span><span class=w>      </span>- <span class=l>decrypt</span><span class=w>
</span><span class=w>      </span>- --<span class=l>ciphertext-file=cloudsqlproxy.json.enc</span><span class=w>
</span><span class=w>      </span>- --<span class=l>plaintext-file=cloudsqlproxy.json</span><span class=w>
</span><span class=w>      </span>- --<span class=l>location=global</span><span class=w>
</span><span class=w>      </span>- --<span class=l>keyring=$_KEYRING</span><span class=w>
</span><span class=w>      </span>- --<span class=l>key=$_KEY</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Decrypt auth.json&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gcloud</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=l>kms</span><span class=w>
</span><span class=w>      </span>- <span class=l>decrypt</span><span class=w>
</span><span class=w>      </span>- --<span class=l>ciphertext-file=auth.json.enc</span><span class=w>
</span><span class=w>      </span>- --<span class=l>plaintext-file=auth.json</span><span class=w>
</span><span class=w>      </span>- --<span class=l>location=global</span><span class=w>
</span><span class=w>      </span>- --<span class=l>keyring=$_KEYRING</span><span class=w>
</span><span class=w>      </span>- --<span class=l>key=$_KEY</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Create env secret manifest&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/kubectl</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;Decrypt .env&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=l>/bin/sh</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- -<span class=l>c</span><span class=w>
</span><span class=w>        </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>        </span><span class=w>        </span><span class=l>kubectl create secret generic env --from-env-file .env --dry-run -n yourapp1 -o yaml &gt; k8s/06.0-app-secret.yaml</span><span class=w>
</span><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;CLOUDSDK_COMPUTE_ZONE=$_ZONE&#34;</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER&#34;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Create cloudsqlproxy secret manifest&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/kubectl</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;Decrypt cloudsqlproxy.json service account&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=l>/bin/sh</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- -<span class=l>c</span><span class=w>
</span><span class=w>      </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>        </span><span class=w>        </span><span class=l>kubectl create secret generic cloudsql-instance-credentials --from-file=cloudsqlproxy.json=./cloudsqlproxy.json --dry-run -n yourapp1 -o yaml &gt; k8s/06.1-cloudsqlproxy.yaml</span><span class=w>
</span><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;CLOUDSDK_COMPUTE_ZONE=$_ZONE&#34;</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;CLOUDSDK_CONTAINER_CLUSTER=$_CLUSTER&#34;</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Build docker image&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=p>[</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;build&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;--build-arg&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;COMPOSER_FLAGS=--prefer-dist --classmap-authoritative --no-dev&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;gcr.io/$PROJECT_ID/yourapp1:$TAG_NAME&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-t&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;gcr.io/$PROJECT_ID/yourapp1:latest&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;.&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>      </span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Push docker image&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/docker</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;push&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;gcr.io/$PROJECT_ID/yourapp1&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Set manifests image TAG_NAME&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gcloud</span><span class=w>
</span><span class=w>    </span><span class=nt>entrypoint</span><span class=p>:</span><span class=w> </span><span class=l>/bin/sh</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=s2>&#34;-c&#34;</span><span class=w>
</span><span class=w>      </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>        sed -i &#39;s/TAG_NAME/$TAG_NAME/g&#39; k8s/06-app-deployment.yaml
</span><span class=sd>        sed -i &#39;s/TAG_NAME/$TAG_NAME/g&#39; k8s/09-queue-deployment.yaml
</span><span class=sd>        sed -i &#39;s/TAG_NAME/$TAG_NAME/g&#39; k8s/11-schedule-deployment.yaml</span><span class=w>        
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Deploy&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gke-deploy</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=p>[</span><span class=s2>&#34;apply&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-f&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;k8s/&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--cluster&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;$_CLUSTER&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;--location&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;$_ZONE&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>
</span><span class=w>  </span>- <span class=nt>id</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Copy assets to bucket&#34;</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/cloud-builders/gsutil</span><span class=w>
</span><span class=w>    </span><span class=nt>waitFor</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;-&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=p>[</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-h&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;Cache-Control:public,max-age=31536000&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-m&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;cp&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-r&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;-Z&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;public/*&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>        </span><span class=s2>&#34;gs://yourapp1bucket&#34;</span><span class=p>,</span><span class=w>
</span><span class=w>      </span><span class=p>]</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>Não vou entrar em detalhes sobre o processo de CI em <code>cloudbuild.ci.yaml</code> pois não é o propósito. Em resumo sobre o processo de CD em <code>cloudbuild.cd.yaml</code>:</p><ul><li>Os arquivos de configuração/environment variables são descriptografados.</li><li>A criação secret <code>env</code> utilizada nos manifestos de <code>06-app-deployment</code>, <code>09-queue-deployment</code> e <code>11-schedule-deployment</code> é simulada com <code>--dry-run</code> a partir do arquivo .env que foi descriptografado e seu output é salvo em <code>k8s/06.0-app-secret.yaml</code>.</li><li>O mesmo processo ser repete para a service account utilizada para que o cloudsqlproxy tenha acesso ao Cloud SQL.</li><li>A imagem docker é criada e tageada com a release tag do repositório e também com a tag latest.</li><li>A palavra TAG_NAME é substituída pela release tag do repositório nos arquivos de manifesto.</li><li>O deploy dos manifestos é realizado.</li><li>Os assets da aplicação são copiados para um bucket.</li></ul><blockquote><p>Dica: Caso queira que um commit não passe pelo processo de CI/CD, adicione <code>[skip cd]</code> à mensagem de commit.</p></blockquote><h2 id=monitorando-o-cluster-com-kontena-lens-e-métricas-prometheus>Monitorando o cluster com Kontena Lens e métricas Prometheus<a hidden class=anchor aria-hidden=true href=#monitorando-o-cluster-com-kontena-lens-e-métricas-prometheus>#</a></h2><p>Usando a api do kubernetes é possível obter vários dados para monitorar o cluster, porém para uma visão gráfica geral de todos os namespaces utilizo o <a href=https://k8slens.dev>Kontena Lens</a>, uma ferramenta grátis e opensource:</p><p><img src=../kontena-lens.png alt="Kontena Lens"></p><p>Após instalá-lo e conectá-lo ao cluster, clique com o botão direito no ícone do cluster e habilite as métricas prometheus.</p><p>Analise ao longo do tempo se as <code>requests</code> e os <code>limits</code> definidos nos deployments estão sendo suficientes ou até mesmo se estão desperdiçando recurso e redefina-os caso necessário.</p><h2 id=realizando-o-deploy-de-outras-aplicações>Realizando o deploy de outras aplicações<a hidden class=anchor aria-hidden=true href=#realizando-o-deploy-de-outras-aplicações>#</a></h2><p>O processo de deploy das outras aplicações é o mesmo, o namespace é diferente, mas os conceitos são os mesmos. Como um rápido exemplo, a quinta aplicação mencionada no início (executada no cloud.run), desta vez com um container apache:</p><p>Exemplo do app-deployment:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>yourapp2</span><span class=w>
</span><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>secret.reloader.stakater.com/reload</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;env&#34;</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>50</span><span class=l>%</span><span class=w>
</span><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span><span class=w>          </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gcr.io/yourproject/yourapp2:TAG_NAME</span><span class=w>
</span><span class=w>          </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;/bin/bash&#34;</span><span class=p>]</span><span class=w>
</span><span class=w>          </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span><span class=w>            </span>- <span class=p>|</span><span class=sd>
</span><span class=sd>              php artisan optimize
</span><span class=sd>              php artisan view:cache
</span><span class=sd>              apache2-foreground</span><span class=w>              
</span><span class=w>          </span><span class=nt>envFrom</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>secretRef</span><span class=p>:</span><span class=w>
</span><span class=w>                </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>env</span><span class=w>
</span><span class=w>          </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span><span class=w>            </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span><span class=w>          </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>50m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span><span class=w>            </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span><span class=w>              </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></code></pre></td></tr></table></div></div><h2 id=problemas-identificados>Problemas identificados<a hidden class=anchor aria-hidden=true href=#problemas-identificados>#</a></h2><p>Aqui vão algumas dicas para que alguém que esteja lendo não passe pelas mesmas situações que passei:</p><h6 id=ative-o-network-plugin-do-gke>Ative o Network Plugin do GKE<a hidden class=anchor aria-hidden=true href=#ative-o-network-plugin-do-gke>#</a></h6><p>Durante as primeiras semanas me deparava com uma mensagem <a href=https://stackoverflow.com/q/61433766/3238672>&ldquo;network is not ready: runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady&rdquo;</a> e os pods reinicializando uma ou duas vezes na semana. A solução é ativar o Network plugin do GKE, que utiliza o <a href=http://projectcalico.org>Calico</a> por trás dos panos.</p><h6 id=reduza-os-recursos-utilizado-pelo-namespace-kube-system>Reduza os recursos utilizado pelo namespace kube-system<a hidden class=anchor aria-hidden=true href=#reduza-os-recursos-utilizado-pelo-namespace-kube-system>#</a></h6><p>Por padrão o GKE declara um limit de 1 vCPU para o <code>fluentd</code> utilizado na captura de logs, esse limite está exagerado para um cluster pequeno como o nosso. Abaixo uma ScalingPolicy das requests and limits do fluentd:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>scalingpolicy.kope.io/v1alpha1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ScalingPolicy</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-gcp-scaling-policy</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-gcp</span><span class=w>
</span><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>            </span><span class=nt>base</span><span class=p>:</span><span class=w> </span><span class=l>15m</span><span class=w>
</span><span class=w>          </span>- <span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span><span class=w>            </span><span class=nt>base</span><span class=p>:</span><span class=w> </span><span class=l>198Mi</span><span class=w>
</span><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span><span class=w>          </span>- <span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span><span class=w>            </span><span class=nt>base</span><span class=p>:</span><span class=w> </span><span class=l>20m</span><span class=w>
</span><span class=w>          </span>- <span class=nt>resource</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span><span class=w>            </span><span class=nt>base</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></code></pre></td></tr></table></div></div><p>980m de cpu a menos do que o padrão definido pelo GKE 😅</p><p>Aplique o arquivo acima:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl apply -f fluentd-gcp-scaling-policy.yaml
</code></pre></td></tr></table></div></div><p>Outras dicas para reduzir recursos consumidos pelo namespace kube-system podem ser encontradas <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/small-cluster-tuning>aqui</a>.</p><h6 id=custo-de-forwading-rules-no-load-balancer>Custo de forwading rules no load balancer<a hidden class=anchor aria-hidden=true href=#custo-de-forwading-rules-no-load-balancer>#</a></h6><p>Como dito anteriormente, entre 1 e 5 forwarding rules o custo é o mesmo, aproximadamente <code>18 USD</code>. Porém, após o deploy de 5 aplicações temos 10 fowarding rules, totalizando mais de <code>50 USD</code>&mldr;</p><p>Possíveis soluções:</p><ul><li><p>Com custo aproximado de <code>18 USD</code>: Utilizar <a href=https://stackoverflow.com/questions/58739513/google-kubernetes-engine-how-to-define-one-ingress-for-multiple-namespaces/60335810#60335810>apenas um load balancer</a> no namespace default com nginx realizando o proxy para os serviços em diferentes namespaces, gerando assim apenas duas forwarding rules. Exemplo de um nginx-configmap para atingir esse objetivo:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-yaml data-lang=yaml><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-configmap</span><span class=w>
</span><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>default.conf</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span><span class=sd>    server {
</span><span class=sd>      listen 80;
</span><span class=sd>      listen [::]:80;
</span><span class=sd>      server_name  _;
</span><span class=sd>
</span><span class=sd>      location / {
</span><span class=sd>        add_header Content-Type text/plain;
</span><span class=sd>        return 200 &#34;OK.&#34;;
</span><span class=sd>      }
</span><span class=sd>    }
</span><span class=sd>
</span><span class=sd>    server {
</span><span class=sd>      listen 80;
</span><span class=sd>      listen [::]:80;
</span><span class=sd>      server_name yourapp1.com www.yourapp1.com;
</span><span class=sd>
</span><span class=sd>      location / {
</span><span class=sd>        proxy_set_header Host            $host;
</span><span class=sd>        proxy_set_header X-Forwarded-For $remote_addr;
</span><span class=sd>        proxy_pass http://nginx.yourapp1.svc.cluster.local:80;
</span><span class=sd>      }
</span><span class=sd>    }
</span><span class=sd>
</span><span class=sd>    server {
</span><span class=sd>      listen 80;
</span><span class=sd>      listen [::]:80;
</span><span class=sd>      server_name yourapp2.com www.yourapp2.com;
</span><span class=sd>
</span><span class=sd>      location / {
</span><span class=sd>        proxy_set_header Host            $host;
</span><span class=sd>        proxy_set_header X-Forwarded-For $remote_addr;
</span><span class=sd>        proxy_pass http://app.yourapp2.svc.cluster.local:8080;
</span><span class=sd>      }
</span><span class=sd>    }</span><span class=w>    
</span></code></pre></td></tr></table></div></div><p>Vantagens:</p><ul><li>Sua aplicação continua utilizando o <a href=https://cloud.google.com/load-balancing>load balancer do Google</a>.</li><li>Os certificados SSL auto gerenciados pelo Google ainda funcionam.</li></ul><p>Desvantagens:</p><ul><li><code>18 USD</code> 😅</li></ul></li><li><p>Com custo <code>0 USD</code>: <a href=https://kubernetes.github.io/ingress-nginx/>Nginx Ingress</a>, <a href=http://traefik.io>Traefik</a>, <a href=https://istio.io/docs/tasks/traffic-management/ingress/>Istio</a> ou outro ingress.</p><p>Vantagens:</p><ul><li><code>0 USD</code></li><li>Features não disponíveis no ingress padrão do Google.</li></ul><p>Desvantagens:</p><ul><li>Aparentemente, bem mais trabalhoso (minha opinião).</li></ul></li></ul><h2 id=próximos-passos>Próximos passos<a hidden class=anchor aria-hidden=true href=#próximos-passos>#</a></h2><p>O processo ao longo dos dias foi bem divertido, agora continuarei monitorando e aprimorando o conhecimento na ferramenta. Se lhe ajudou ou se tem sugestões, deixe um comentário abaixo :)</p><p>Conteúdos que me ajudaram no processo:</p><ul><li><a href=https://kubernetes.io>https://kubernetes.io</a></li><li><a href=https://www.k8sref.io>https://www.k8sref.io</a></li><li><a href=https://itsmetommy.com>https://itsmetommy.com</a></li><li><a href=https://k8s.af>https://k8s.af</a></li></ul><p>Último recado:</p><p><img src=../keep-it-simple.jpeg alt="Keep it simple stupid!"></p><p>Só se aventure com Kubernetes <code>para aprendizado</code> ou <code>se fizer sentido</code> para seu projeto <code>e resolver algum problema existente</code> como foi mostrado nesse artigo. Não complique o que está funcionando perfeitamente.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://ibrunotome.github.io/tags/gcp/>gcp</a></li><li><a href=https://ibrunotome.github.io/tags/laravel/>laravel</a></li><li><a href=https://ibrunotome.github.io/tags/devops/>devops</a></li><li><a href=https://ibrunotome.github.io/tags/kubernetes/>kubernetes</a></li></ul></footer><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//ibrunotome.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></article></main><footer class=footer><span>&copy; 2021 <a href=https://ibrunotome.github.io>Bruno Tomé</a></span>
<span>&#183;</span>
<span>Powered by <a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a></span>
<span>&#183;</span>
<span>Theme <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script defer src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><script>window.onload=function(){localStorage.getItem("menu-scroll-position")&&(document.getElementById('menu').scrollLeft=localStorage.getItem("menu-scroll-position"))},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})});var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")};function menu_on_scroll(){localStorage.setItem("menu-scroll-position",document.getElementById('menu').scrollLeft)}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>